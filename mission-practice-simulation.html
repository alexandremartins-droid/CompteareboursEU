<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mission 2 ‚Äì The Practice (Interactive Simulation)</title>

  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;600;700;900&family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --c-cyan:#19dfff;
      --c-cyan2:#3bc4ff;
      --c-text:#d4e7ff;
      --c-text2:#b8dfff;
      --c-border:rgba(255,255,255,0.10);
      --c-card:rgba(255,255,255,0.06);
      --c-dark:rgba(0,0,0,0.35);
      --shadow: 0 0 20px rgba(0,0,0,0.35);
      --glow: 0 0 22px rgba(25,223,255,0.22);
    }

    html, body{
      margin:0;
      padding: 34px 0 46px; /* ‚úÖ no left/right margin */
      background:transparent !important;
      font-family:'Inter', sans-serif;
      color:var(--c-text);
      line-height:1.65;
    }

    /* Header */
    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:0 0; /* ‚úÖ no left/right padding */
    }

    .header-badge{
      display:inline-block;
      padding:7px 16px;
      font-size:12px;
      border-radius:22px;
      border:1px solid rgba(42,168,255,0.65);
      color:#2aa8ff;
      letter-spacing:1px;
      text-transform:uppercase;
      background: rgba(0,0,0,0.20);
      backdrop-filter: blur(10px);
      box-shadow: 0 0 0 1px rgba(255,255,255,0.04);
      animation: popIn 520ms ease both;
    }

    h1{
      font-family:'Orbitron', sans-serif;
      font-size:44px;
      font-weight:900;
      letter-spacing:3px;
      color:#ffffff;
      margin:14px 0 10px 0;
      animation: popIn 560ms ease both;
    }

    .subtitle{
      max-width:1100px;
      color:var(--c-text2);
      margin:0 0 22px 0;
      font-size:15px;
      animation: popIn 650ms ease both;
      opacity:0.95;
    }

    /* Game container */
    #game-container{
      max-width:1100px;
      margin: 18px auto 0;
      background:var(--c-card);
      border:1px solid rgba(255,255,255,0.08);
      border-radius:18px;
      padding:26px 26px;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }

    /* Ambient animated highlight */
    #game-container:before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(900px 320px at 15% 0%, rgba(25,223,255,0.16), transparent 60%),
        radial-gradient(700px 280px at 85% 15%, rgba(59,196,255,0.12), transparent 60%);
      pointer-events:none;
      animation: shimmer 5.8s ease-in-out infinite;
      opacity:0.85;
    }

    /* Story panel animation */
    .panel{
      position:relative;
      opacity:1;
      transform: translateY(0);
      transition: opacity 260ms ease, transform 260ms ease;
    }
    .panel.is-leaving{ opacity:0; transform: translateY(12px); }
    .panel.is-entering{ opacity:0; transform: translateY(-10px); }
    .panel.is-entered{ opacity:1; transform: translateY(0); }

    /* ‚úÖ Question (more visible) */
    #story h2{
      font-family:'Orbitron', sans-serif;
      font-size:26px;           /* ‚úÖ bigger */
      letter-spacing:3px;
      color:var(--c-cyan2);
      text-transform:uppercase;
      margin:0 0 12px 0;
      text-shadow: 0 0 18px rgba(59,196,255,0.22);
    }
    #story p{
      margin:0;
      font-size:20px;           /* ‚úÖ bigger */
      color:#ffffff;            /* ‚úÖ more readable */
      opacity:0.95;
    }

    /* ‚úÖ Status mini-card shown between steps (like diagram cards) */
    .status-card{
      margin-top:14px;
      background: rgba(0,0,0,0.32);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius:14px;
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      backdrop-filter: blur(12px);
      animation: popIn 420ms ease both;
      box-shadow: 0 0 0 1px rgba(255,255,255,0.03);
    }
    .status-left{
      font-size:14px;
      color: var(--c-text2);
      letter-spacing:0.2px;
    }
    .pills{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .pill{
      background: rgba(0,0,0,0.25);
      border:1px solid rgba(255,255,255,0.10);
      border-radius:12px;
      padding:6px 10px;
      font-size:13px;
      color:#ffffff;
      display:flex;
      gap:8px;
      align-items:center;
      box-shadow: 0 0 16px rgba(0,0,0,0.18);
    }
    .pill b{ color: var(--c-cyan2); }

    /* Choices */
    #choices{
      position:relative;
      margin-top:18px;
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 860px){
      #choices{ grid-template-columns: 1fr 1fr; }
    }

    /* ‚úÖ Answers more readable/bigger */
    .choice-btn{
      width:100%;
      border:1px solid rgba(59,196,255,0.38);
      background: rgba(0,0,0,0.34);
      color:#ffffff;
      border-radius:16px;
      padding:18px 18px;
      cursor:pointer;
      font-size:18px;       /* ‚úÖ bigger */
      font-weight:900;      /* ‚úÖ stronger */
      letter-spacing:0.4px;
      text-align:left;
      transition: 0.22s ease;
      backdrop-filter: blur(12px);
      box-shadow: 0 0 0 1px rgba(255,255,255,0.03);
      position:relative;
      overflow:hidden;
    }
    .choice-btn:before{
      content:"";
      position:absolute;
      inset:0;
      background: radial-gradient(500px 140px at 20% 0%, rgba(25,223,255,0.12), transparent 60%);
      opacity:0;
      transition: 0.25s ease;
    }
    .choice-btn:hover{
      transform: translateY(-2px);
      border-color: rgba(59,196,255,0.78);
      box-shadow: 0 0 20px rgba(59,196,255,0.18);
    }
    .choice-btn:hover:before{ opacity:1; }

    /* Stats */
    #stats{
      position:relative;
      margin-top:22px;
      padding-top:14px;
      border-top:1px solid rgba(255,255,255,0.12);
      display:flex;
      flex-wrap:wrap;
      gap:10px 16px;
      justify-content:space-between;
    }
    .stat{
      background: rgba(0,0,0,0.26);
      border:1px solid rgba(255,255,255,0.08);
      border-radius:14px;
      padding:10px 12px;
      min-width: 260px;
      backdrop-filter: blur(10px);
      animation: popIn 520ms ease both;
    }
    .stat b{
      color:var(--c-cyan2);
      letter-spacing:0.2px;
      font-weight:900;
    }

    /* Final score card */
    .score-card{
      margin-top:18px;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(59,196,255,0.35);
      border-radius: 16px;
      padding: 16px 18px;
      backdrop-filter: blur(12px);
      box-shadow: var(--glow);
      animation: popIn 520ms ease both;
    }
    .score-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
    }
    .score-left{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .score-label{
      font-family:'Orbitron', sans-serif;
      text-transform:uppercase;
      letter-spacing:2px;
      color:#ffffff;
      font-size:14px;
      opacity:0.9;
    }
    .score-value{
      font-family:'Orbitron', sans-serif;
      font-size:40px;
      font-weight:900;
      letter-spacing:3px;
      color:var(--c-cyan);
      margin:0;
      text-shadow: 0 0 18px rgba(25,223,255,0.26);
    }

    /* Final button */
    .final-cta{
      margin-left:auto;
      display:flex;
      justify-content:flex-end;
      align-items:center;
    }
    .btn-enter{
      display:inline-block;
      text-decoration:none;
      font-family:'Orbitron', sans-serif;
      font-size:16px;
      font-weight:900;
      letter-spacing:2px;
      text-transform:uppercase;
      padding:14px 22px;
      border-radius:16px;
      background:var(--c-cyan);
      color:#ffffff;              /* ‚úÖ text white */
      border:1px solid rgba(25,223,255,0.55);
      transition: 0.22s ease;
      white-space:nowrap;
      box-shadow: 0 0 18px rgba(25,223,255,0.18);
    }
    .btn-enter:hover{
      background:#4be9ff;
      transform: translateY(-2px);
      box-shadow: 0 0 24px rgba(25,223,255,0.26);
    }

    /* Modal */
    .modal-overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,0.58);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 22px;
      z-index:9999;
    }
    .modal{
      width: min(720px, 100%);
      background: rgba(10,20,35,0.88);
      border:1px solid rgba(255,255,255,0.10);
      border-radius: 18px;
      padding: 18px 18px 14px 18px;
      backdrop-filter: blur(14px);
      box-shadow: 0 0 30px rgba(0,0,0,0.55);
      animation: popIn 260ms ease both;
    }
    .modal h3{
      margin:0 0 10px 0;
      font-family:'Orbitron', sans-serif;
      color:#ffffff;
      letter-spacing:2px;
      text-transform:uppercase;
      font-size:16px;
    }
    .modal p{
      margin:0 0 14px 0;
      color:#d4e7ff;
      font-size:25px;
      line-height:1.8;
    }
    .modal-actions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .modal-btn{
      border:1px solid rgba(255,255,255,0.12);
      border-radius: 14px;
      padding: 10px 14px;
      font-weight:900;
      cursor:pointer;
      transition: 0.2s ease;
      font-family:'Orbitron', sans-serif;
      letter-spacing:1px;
      text-transform:uppercase;
      color:#ffffff;
    }
    .modal-btn.primary{
      background:var(--c-cyan);
      border-color: rgba(25,223,255,0.55);
    }
    .modal-btn.primary:hover{ transform: translateY(-1px); background:#4be9ff; }
    .modal-btn.secondary{
      background: rgba(0,0,0,0.25);
      border-color: rgba(59,196,255,0.35);
    }
    .modal-btn.secondary:hover{ transform: translateY(-1px); border-color: rgba(59,196,255,0.75); }

    @keyframes popIn{
      from{ opacity:0; transform: translateY(10px); }
      to{ opacity:1; transform: translateY(0); }
    }
    @keyframes shimmer{
      0%,100%{ transform: translateY(0); filter: blur(0px); opacity:0.80; }
      50%{ transform: translateY(-6px); filter: blur(0.2px); opacity:1; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header-badge">Mission: Connected Heroes ¬∑ The Practice</div>
    <h1>Interactive Simulation</h1>
    <p class="subtitle">
      Make your choices step by step. Each decision impacts your <b>time</b>, your <b>battery</b> and your <b>progress</b>.
    </p>

    <main id="game-container">
      <section id="story" class="panel" aria-live="polite"></section>
      <section id="choices"></section>

      <aside id="stats">
        <div class="stat">‚è± Time : <b><span id="time">00:00</span></b></div>
        <div class="stat">üîã Battery : <b><span id="battery">50</span></b>%</div>
        <div class="stat">üìç Progress : <b><span id="progress">0</span></b> / 1000 km</div>
      </aside>

      <div id="finalScore" style="display:none;"></div>
    </main>
  </div>

  <!-- Modal -->
  <div id="modalOverlay" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <h3 id="modalTitle">Decision</h3>
      <p id="modalText"></p>
      <div class="modal-actions">
        <button id="modalNo" class="modal-btn secondary" type="button">No</button>
        <button id="modalYes" class="modal-btn primary" type="button">Yes</button>
      </div>
    </div>
  </div>

<script>
  /* =========================
     GAME STATE
  ========================= */
  let battery = 50;        // %
  let timeMin = 0;         // minutes
  let kmDone = 0;          // progress

  let prep = "50";         // "50" | "80" | "100"
  let gps = "eVrouting";   // "Google Maps" | "eRoute" | "eVrouting"
  let driving = "Balanced";// "Eco" | "Balanced" | "Sport"
  let usedMyBrand = null;  // true | false

  let stationsChoice = null; // "stop20" | "go180"

  const TOTAL_KM = 1000;

  /* =========================
     HELPERS
  ========================= */
  function clampState(){
    if (timeMin < 0) timeMin = 0;
    battery = Math.max(0, Math.min(100, Math.round(battery)));
    kmDone = Math.max(0, Math.min(TOTAL_KM, Math.round(kmDone)));
  }

  function minutesToHHMM(m){
    const mm = Math.max(0, Math.round(m));
    const h = Math.floor(mm / 60);
    const r = mm % 60;
    return `${String(h).padStart(2,"0")}:${String(r).padStart(2,"0")}`;
  }

  function gpsPenaltyFactor(){
    // PDF note: Google Maps +10% / e-Routes +5% / EVR 0%  [oai_citation:1‚Ä°Blank diagram (2).pdf](sediment://file_00000000d69871f49afef9498f8a1086)
    if (gps === "Google Maps") return 1.10;
    if (gps === "eRoute") return 1.05;
    return 1.00;
  }

  function updateStats(){
    clampState();
    const bEl = document.getElementById("battery");
    const tEl = document.getElementById("time");
    const pEl = document.getElementById("progress");
    if (bEl) bEl.textContent = battery;
    if (tEl) tEl.textContent = minutesToHHMM(timeMin);
    if (pEl) pEl.textContent = kmDone;
    sendHeightDelayed();
  }

  function transitionTo(html){
    const story = document.getElementById("story");
    story.classList.add("is-leaving");
    setChoices([]);

    setTimeout(() => {
      story.classList.remove("is-leaving");
      story.classList.add("is-entering");
      story.innerHTML = html;

      requestAnimationFrame(() => {
        story.classList.add("is-entered");
        story.classList.remove("is-entering");
        setTimeout(() => story.classList.remove("is-entered"), 260);
      });

      sendHeightDelayed();
    }, 220);
  }

  function setStory(html){
    document.getElementById("story").innerHTML = html;
    sendHeightDelayed();
  }

  function setChoices(choices){
    const container = document.getElementById("choices");
    container.innerHTML = "";

    choices.forEach(choice => {
      const btn = document.createElement("button");
      btn.className = "choice-btn";
      btn.type = "button";
      btn.textContent = choice.label;
      btn.addEventListener("click", choice.action);
      container.appendChild(btn);
    });

    sendHeightDelayed();
  }

  /* =========================
     SCORE
  ========================= */
  function computeScore(){
    const base = 1000;
    const refSlow = 995; // 16h35
    const timeRatio = Math.min(1, timeMin / refSlow);
    const timePenalty = Math.round(timeRatio * 850);
    const batteryBonus = Math.round((battery / 100) * 250);
    const score = Math.max(0, base - timePenalty + batteryBonus);
    return { score };
  }

  function showFinalScore(){
    const { score } = computeScore();
    const wrap = document.getElementById("finalScore");
    if (!wrap) return;

    wrap.style.display = "block";
    wrap.innerHTML = `
      <div class="score-card">
        <div class="score-top">
          <div class="score-left">
            <div class="score-value">${score}</div>
          </div>
          <div class="final-cta">
            <a class="btn-enter" href="https://forms.cloud.microsoft/e/iHrWwNt9Bt" target="_blank" rel="noopener">
              ENTER THE CODE
            </a>
          </div>
        </div>
      </div>
    `;
    sendHeightDelayed();
  }

  /* =========================
     TIMINGS (from PDF)
     - We use absolute ‚Äúclock‚Äù totals at key milestones.
     - Values are extracted from the diagram (ex: 15:00 | 50% | 1000/1000km)  [oai_citation:2‚Ä°Blank diagram (2).pdf](sediment://file_00000000d69871f49afef9498f8a1086)
  ========================= */

  // After Step 1 (prep choice): time baseline
  const PREP_BASE_TIME = {
    "50": 0,     // leave immediately: 00:00  [oai_citation:3‚Ä°Blank diagram (2).pdf](sediment://file_00000000d69871f49afef9498f8a1086)
    "80": 45,    // 00:45  [oai_citation:4‚Ä°Blank diagram (2).pdf](sediment://file_00000000d69871f49afef9498f8a1086)
    "100": 135   // 02:15  [oai_citation:5‚Ä°Blank diagram (2).pdf](sediment://file_00000000d69871f49afef9498f8a1086)
  };

  // After Step 3 (300 km) totals for each prep & driving (diagram blocks)
  const T300 = {
    "50":  { Eco: 200, Balanced: 165, Sport: 120 },    // 03:20 / 02:45 / 02:00  [oai_citation:6‚Ä°Blank diagram (2).pdf](sediment://file_00000000d69871f49afef9498f8a1086)
    "80":  { Eco: 245, Balanced: 210, Sport: 165 },    // 04:05 / 03:30 / 02:45  [oai_citation:7‚Ä°Blank diagram (2).pdf](sediment://file_00000000d69871f49afef9498f8a1086)
    "100": { Eco: 335, Balanced: 300, Sport: 255 }     // 05:35 / 05:00 / 04:15  [oai_citation:8‚Ä°Blank diagram (2).pdf](sediment://file_00000000d69871f49afef9498f8a1086)
  };

  // After Step 4 (stop at next station, 320 km) totals per prep & driving
  // (only values clearly shown in diagram; keeps your wording)
  const T320_STOP20 = {
    "50":  { Eco: 305, Balanced: 300, Sport: 315, batteryEco: 100, batteryOther: 80 }, // 05:05 / 05:00 / 05:15  [oai_citation:9‚Ä°Blank diagram (2).pdf](sediment://file_00000000d69871f49afef9498f8a1086)
    "80":  { Eco: 350, Balanced: 255, Sport: 210, batteryEco: 80,  batteryOther: 80 }, // 05:50 / 04:15 / 03:30  [oai_citation:10‚Ä°Blank diagram (2).pdf](sediment://file_00000000d69871f49afef9498f8a1086)
    "100": { Eco: 380, Balanced: 345, Sport: 300, batteryEco: 100, batteryOther: 80 }  // 06:20 / 05:45 / 05:00  [oai_citation:11‚Ä°Blank diagram (2).pdf](sediment://file_00000000d69871f49afef9498f8a1086)
  };

  // After Step 6 (400km segment milestone): 700 km totals (EVR baseline), then apply GPS % malus  [oai_citation:12‚Ä°Blank diagram (2).pdf](sediment://file_00000000d69871f49afef9498f8a1086)
  const T700_BASE_EVR = { Balanced: 470, Sport: 390, Eco: 615 }; // 07:50 / 06:30 / 10:15  [oai_citation:13‚Ä°Blank diagram (2).pdf](sediment://file_00000000d69871f49afef9498f8a1086)
  const B700 = { Balanced: 30, Sport: 10, Eco: 55 };             // 30% / 10% / 55%  [oai_citation:14‚Ä°Blank diagram (2).pdf](sediment://file_00000000d69871f49afef9498f8a1086)

  // After Step 5 (Long break & charging station) totals at 700 km
  // YES (use app) => faster but ends at 80%
  // NO => slower but ends at 100%  [oai_citation:15‚Ä°Blank diagram (2).pdf](sediment://file_00000000d69871f49afef9498f8a1086)
  const T700_CHARGE_YES = { Balanced: 530, Sport: 540, Eco: 660 }; // 08:50 / 09:00 / 11:00  [oai_citation:16‚Ä°Blank diagram (2).pdf](sediment://file_00000000d69871f49afef9498f8a1086)
  const T700_CHARGE_NO  = { Balanced: 590, Sport: 600, Eco: 720 }; // 09:50 / 10:00 / 12:00  [oai_citation:17‚Ä°Blank diagram (2).pdf](sediment://file_00000000d69871f49afef9498f8a1086)
  const B700_CHARGE_YES = 80;
  const B700_CHARGE_NO  = 100;

  // Step 7 travel to the tire alert milestone (940 km): the diagram shows +2h25 or +1h50 depending paths  [oai_citation:18‚Ä°Blank diagram (2).pdf](sediment://file_00000000d69871f49afef9498f8a1086)
  // We keep it consistent and simple: Sport = faster (1h50), Eco/Balanced = 2h25
  const DELTA_TO_940 = { Eco: 145, Balanced: 145, Sport: 110 };

  // From 940 km to 1000 km depending resolution  [oai_citation:19‚Ä°Blank diagram (2).pdf](sediment://file_00000000d69871f49afef9498f8a1086)
  const DELTA_940_TO_1000_CALLCENTER = 45; // 14:25 -> 15:10
  const DELTA_940_TO_1000_ROADSIDE   = 130; // 1h30 + 0h40
  const DELTA_940_TO_1000_LOCAL      = 1440; // +24h

  /* =========================
     FLOW
  ========================= */
  function startGame(){
    battery = 50;
    timeMin = 0;
    kmDone = 0;
    prep = "50";
    gps = "eVrouting";
    driving = "Balanced";
    usedMyBrand = null;
    stationsChoice = null;

    const fs = document.getElementById("finalScore");
    if (fs) fs.style.display = "none";

    setStory(`
      <h2>Mission briefing</h2>
      <p>Your mission today is to travel a long distance of 1,000 km in a Stellantis prototype vehicle (equipped with all the connected services deployed by the
manufacturer worldwide).</p>
      <p><strong>
      The goal is to reach the superhero laboratory that will take you to Mission #3, optimizing your route as much as possible to arrive at your destination as quickly as possible, but above all within a maximum of 24 hours.
      </strong></p><br>
      <p><strong>Here is the briefing information available to you:</strong></p>
      <p>ü•∂ It is cold, with temperatures below freezing.</p>
      <p>üõ£ The terrain along the route is sometimes hostile: tunnels, white zones, accident-prone roads, significant elevation changes, uninhabited areas over varying distances, etc.</p>
      <p>‚ö° Service stations are not always very close to each other.</p>
      <p>üõú Your vehicle is already connected.</p>
      <p>üì± You have a latest-generation smartphone with access to your vehicle's brand app.</p>
      <p><br><strong>PLEASE NOTE:</strong> This mission is a simulated journey. Under no circumstances do the calculated data provide results that correspond to reality on the ground. This is a game in which the data are consistent with each other but do not represent reality.</br>
      Sometimes, being a hero is all about playing it safe. </p>
    `);

    setChoices([{ label: "Let's go! üöÄ", action: () => step1VehiclePrep() }]);
    updateStats();
  }

  function step1VehiclePrep(){
    transitionTo(`
      <h2>Step 1 ‚Äì Vehicle preparation</h2>
      <p>The mission begins... your commander hands you an envelope containing the key to your electric vehicle, a smartphone, and the phone number.
When you open the smartphone, you see that you have received a text message with your username and password for your Brand app.</br></p>
      <p><br>The car is connected and ready to go, the battery is 50% charged.</p>
      <p><br>The only slight problem is that the mission countdown has started...</p>
      <p><strong>What do you do?</strong></p>
    `);

    setChoices([
      { label: "You leave immediately", action: () => { prep="50"; timeMin = PREP_BASE_TIME[prep]; battery=50; kmDone=0; step2Copilot(); } },
      { label: "You charge the battery to 80% while planning to preheat the cabin", action: () => { prep="80"; timeMin = PREP_BASE_TIME[prep]; battery=80; kmDone=0; step2Copilot(); } },
      { label: "You charge the battery to 80% without preheating the cabin.", action: () => { prep="80"; timeMin = PREP_BASE_TIME[prep]; battery=80; kmDone=0; step2Copilot(); } },
      { label: "You charge the battery to 100% while planning to preheat the cabin.", action: () => { prep="100"; timeMin = PREP_BASE_TIME[prep]; battery=100; kmDone=0; step2Copilot(); } },
      { label: "You charge the battery to 100% without preheating the cabin.", action: () => { prep="100"; timeMin = PREP_BASE_TIME[prep]; battery=100; kmDone=0; step2Copilot(); } }
    ]);

    updateStats();
  }

  function step2Copilot(){
    transitionTo(`
      <h2>Step 2 ‚Äì Choose your digital co-pilot</h2>
      <p>The route to the Mission 3 laboratory is completely unfamiliar to you. You need a GPS to guide you.</p><br>
      <p><strong>Which service will you choose to accompany you on your journey?</strong><p>
    `);

    setChoices([
      { label: "Google Maps", action: () => { gps="Google Maps"; step3DrivingStyle(); } },
      { label: "e-Routes by Free2move Charge", action: () => { gps="eRoute"; step3DrivingStyle(); } },
      { label: "EV Routing Embedded", action: () => { gps="eVrouting"; step3DrivingStyle(); } }
    ]);

    updateStats();
  }

  function step3DrivingStyle(){
    transitionTo(`
      <h2>Step 3 ‚Äì Driving style (first 300 km)</h2>
      <p>You enter a long highway stretch of <b>300 km</b>. Choose your driving style.</p>
    `);

    setChoices([
      { label: "Eco driving", action: () => {
          driving="Eco";
          timeMin = T300[prep].Eco;
          // batteries at 300 are shown in diagram (varies by prep); keep the main ‚Äú80% prep‚Äù figures as reference
          // We keep the current battery if you want it strictly; but to stay consistent visually, we align with the 80% prep block:
          battery = (prep==="50") ? 30 : (prep==="80") ? 65 : 85;
          kmDone = 300;
          step4Stations();
        }
      },
      { label: "Balanced driving", action: () => {
          driving="Balanced";
          timeMin = T300[prep].Balanced;
          battery = (prep==="50") ? 15 : (prep==="80") ? 45 : 65;
          kmDone = 300;
          step4Stations();
        }
      },
      { label: "Sport driving", action: () => {
          driving="Sport";
          timeMin = T300[prep].Sport;
          battery = (prep==="50") ? 10 : (prep==="80") ? 20 : 40;
          kmDone = 300;
          step4Stations();
        }
      }
    ]);

    updateStats();
  }

  /* =========================
     Step 4 ‚Äì Stations
  ========================= */
  function step4Stations(){
    transitionTo(`
      <h2>Step 4 ‚Äì Countryside road & charging stations</h2>
      <p>You are in a white zone with a winding road and a slight incline. <strong>What do you do?</strong></br>
      You have two options: Go to the station <strong>20 km away</strong>, where the service station are not immediately available, or drive <strong>180 km</strong> to the second station with
available charging stations.</p>
    `);

    setChoices([
      {
        label: "I will stop at the first service station 20 km away, even if I must wait.",
        action: () => {
          stationsChoice = "stop20";

          const pack = T320_STOP20[prep];
          timeMin = pack[driving];
          kmDone = 320;

          // battery at 320 according to diagram blocks
          if (driving === "Eco") battery = pack.batteryEco;
          else battery = pack.batteryOther;

          // Next: Step 5 (as requested)
          step5LongBreakCharge();
        }
      },
      {
        label: "I prefer not to waste time and will continue to the second charging station.",
        action: () => {
          stationsChoice = "go180";

          // For Eco/Balanced we keep your previous ‚Äúreach further station‚Äù state (480km/80%)
          // Sport triggers the breakdown later (kept as before).
          if (driving !== "Sport") {
            kmDone = 480;
            battery = 80;

            // Keep your former values (not fully explicit per diagram for every prep variant)
            if (driving === "Balanced") timeMin = Math.max(timeMin, 330); // 05:30
            if (driving === "Eco")      timeMin = Math.max(timeMin, 350); // 05:50
          }

          // Next: Step 5
          step5LongBreakCharge();
        }
      }
    ]);

    updateStats();
  }

  /* =========================
     Step 5 ‚Äì Long break & charging station (moved BEFORE 400km segment)
  ========================= */
  function step5LongBreakCharge(){
    transitionTo(`
      <h2>Step 5 ‚Äì Long break & charging station</h2>
      <p>You stop for a long break and charge your vehicle.</p>
    `);

    setChoices([
      { label: "Use my[Brand] app during charging", action: () => {
          usedMyBrand = true;

          // Set to diagram totals at 700 km after charging (YES)  [oai_citation:20‚Ä°Blank diagram (2).pdf](sediment://file_00000000d69871f49afef9498f8a1086)
          timeMin = T700_CHARGE_YES[driving] ?? timeMin;
          battery = B700_CHARGE_YES;

          // Now Step 6 (400km segment)
          step6Segment400();
        }
      },
      { label: "Do not use the app", action: () => {
          usedMyBrand = false;

          // Set to diagram totals at 700 km after charging (NO)  [oai_citation:21‚Ä°Blank diagram (2).pdf](sediment://file_00000000d69871f49afef9498f8a1086)
          timeMin = T700_CHARGE_NO[driving] ?? timeMin;
          battery = B700_CHARGE_NO;

          step6Segment400();
        }
      }
    ]);

    updateStats();
  }

  /* =========================
     Incident (Sport + go180)
  ========================= */
  function stepBreakdown(){
    transitionTo(`
      <h2>Incident</h2>
      <p>Your vehicle breaks down before you reach the charging station.</p>
    `);

    setChoices([
      {
        label: "Call Roadside Assistance",
        action: () => {
          // After assistance, you still continue the journey.
          // We keep the same path; we force sport as per your initial logic.
          driving = "Sport";
          // Continue to Step 6
          step6Segment400(true);
        }
      }
    ]);

    updateStats();
  }

  /* =========================
     Step 6 ‚Äì 400 km segment
     (arrives at 700 km totals + copilot malus)
  ========================= */
  function step6Segment400(fromBreakdown=false){
    // Trigger the incident here (Sport + go180)
    if (!fromBreakdown && driving === "Sport" && stationsChoice === "go180") {
      stepBreakdown();
      return;
    }

    transitionTo(`
      <h2>Step 6 ‚Äì 400 km segment</h2>
      <p>You enter a new <b>400 km</b> segment.</p>
    `);

    setChoices([
      {
        label: "Continue",
        action: () => {
          // Arrive 700km with baseline EVR totals, then apply GPS malus on the 400km segment total  [oai_citation:22‚Ä°Blank diagram (2).pdf](sediment://file_00000000d69871f49afef9498f8a1086)
          const base = T700_BASE_EVR[driving] ?? timeMin;
          timeMin = Math.round(base * gpsPenaltyFactor());
          battery = B700[driving] ?? battery;
          kmDone = 700;

          // Next: Step 7 (tire pressure alert)
          step7TireAlert();
        }
      }
    ]);

    updateStats();
  }

  /* =========================
     Step 7 ‚Äì Tire pressure alert
     + tire burst branch now ALWAYS reaches lab:
       - Roadside Assistance => +130 min, arrive (battery 55)
       - No roadside => +24h, arrive (battery 35)
  ========================= */
  function step7TireAlert(){
    transitionTo(`
      <h2>Step 7 ‚Äì Tire pressure alert</h2>
      <p>There are only 280 km left to reach the laboratory. You are on a beautiful highway, but the weather conditions are poor. It is raining heavily.
60 km from your destination, you receive a low tire pressure alert.</p><br>
      <p>Bad luck! You were almost there! You can't afford to make the wrong decision</p>
      <p>The highway is in a valley, enclosed in the middle of a canyon, and cell phone reception is poor.</p><br></br>
      <p><strong>What do you do?</strong></p>
    `);

    setChoices([
      { label: "You play it safe and immediately contact the call center via your assistant call button to get recommendations.", action: () => stepCallCenterPath() },
      { label: "60 km, no time to waste. The tires can wait until you arrive. You keep driving.",  action: () => stepKeepDrivingExplosion() }
    ]);

    updateStats();
  }

  function stepCallCenterPath(){
    transitionTo(`
      <h2>CALL CENTER</h2>
      <p>You locate the next station to reinflate your tires.</p>
    `);

    setChoices([
      { label: "Continue", action: () => {
          // Move to 940 km milestone
          timeMin += (DELTA_TO_940[driving] ?? 145);
          kmDone = 940;
          battery = 60; // diagram shows 60% at 940  [oai_citation:23‚Ä°Blank diagram (2).pdf](sediment://file_00000000d69871f49afef9498f8a1086)

          // Arrive to 1000 with call center path: 14:25 -> 15:10 (+45) and final battery ~50%  [oai_citation:24‚Ä°Blank diagram (2).pdf](sediment://file_00000000d69871f49afef9498f8a1086)
          timeMin += DELTA_940_TO_1000_CALLCENTER;
          kmDone = 1000;
          battery = 50;

          stepFinalQuestion();
        }
      }
    ]);

    updateStats();
  }

  function stepKeepDrivingExplosion(){
    transitionTo(`
      <h2>Critical failure</h2>
      <p>Your tire explodes. You can‚Äôt keep driving.</p>
    `);

    // IMPORTANT: no restart, everyone can still arrive
    setChoices([
      { label: "Call Roadside Assistance", action: () => resolveTireBurst(true) },
      { label: "Call a point of sale nearby", action: () => resolveTireBurst(false) }
    ]);

    updateStats();
  }

  function resolveTireBurst(useRoadside){
    // First reach the 940 km milestone (same as the other branch)
    timeMin += (DELTA_TO_940[driving] ?? 145);
    kmDone = 940;
    battery = 60; // shown at 940  [oai_citation:25‚Ä°Blank diagram (2).pdf](sediment://file_00000000d69871f49afef9498f8a1086)

    if (useRoadside){
      // Roadside assistance: +1h30 + 0h40 (=130min) => arrive, battery ~55  [oai_citation:26‚Ä°Blank diagram (2).pdf](sediment://file_00000000d69871f49afef9498f8a1086)
      timeMin += DELTA_940_TO_1000_ROADSIDE;
      kmDone = 1000;
      battery = 55;
    } else {
      // No roadside: +24h, arrive anyway, battery ~35  [oai_citation:27‚Ä°Blank diagram (2).pdf](sediment://file_00000000d69871f49afef9498f8a1086)
      timeMin += DELTA_940_TO_1000_LOCAL;
      kmDone = 1000;
      battery = 35;
    }

    stepFinalQuestion();
  }

  /* =========================
     Final question + GPS malus on the delta minutes (0/5/15)
  ========================= */
  function stepFinalQuestion(){
    transitionTo(`
      <h2>Final question</h2>
      <p><strong>Phew! The laboratory is in sight and you're still on schedule.</strong>
        <br>But then, you receive a mysterious call: you are told that you need to find a code to open the entrance gate to the laboratory.
The code requested is the name of the physicist best known for inventing the light bulb. You can't afford to make a mistake; you only have one try.
You're not sure of the answer...and are looking for help.</br>
        <br><strong>What do you do?</strong></br>
      </p>
    `);

    setChoices([
      { label: "Use voice recognition to consult ChatGPT", action: () => applyArrivalDelta(0) },
      { label: "Use your ‚ÄúAlexa vehicle to Home‚Äù service", action: () => applyArrivalDelta(5) },
      { label: "Consult your best friend, a high school physics teacher", action: () => applyArrivalDelta(15) }
    ]);

    updateStats();
  }

  function applyArrivalDelta(deltaMinutes){
    const adjusted = Math.round(deltaMinutes * gpsPenaltyFactor()); // per note  [oai_citation:28‚Ä°Blank diagram (2).pdf](sediment://file_00000000d69871f49afef9498f8a1086)
    timeMin += adjusted;
    endWin();
  }

  function endWin(){
    updateStats();

    transitionTo(`
      <h2 style="font-size:30px; color: #ffffff; text-shadow: 0 0 20px rgba(25,223,255,0.25);">
        Congratulations, you have overcome most of the obstacles and arrived safely at the Laboratory !
      </h2>
      <p style="font-size:16px; color: rgba(212,231,255,0.92); margin-top:6px;">
        Take a few hours to rest. You are now expected in the ‚ÄúAsteroid‚Äù room to continue your mission.
        <br><strong>Don't forget to enter your digital code to confirm your arrival.</strong></br>
      </p>
    `);

    setChoices([]); // only Enter the code below
    showFinalScore();
  }

  /* =========================
     SHAREPOINT IFRAME RESIZE
  ========================= */
  function sendHeight(){
    const height = document.documentElement.scrollHeight;
    parent.postMessage({ type: "resizePracticeSim", height }, "*");
  }
  function sendHeightDelayed(){ setTimeout(sendHeight, 220); }

  window.addEventListener("load", () => { sendHeight(); setInterval(sendHeight, 900); });
  window.addEventListener("resize", sendHeight);

  /* START */
  startGame();
</script>
</body>
</html>
