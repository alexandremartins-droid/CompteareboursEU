<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mission 2 ‚Äì The Practice (Interactive Simulation)</title>

  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;600;700;900&family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --cyan:#19dfff;
      --cyan2:#3bc4ff;
      --text:#d4e7ff;
      --muted:#cfe2ff;
      --bgCard:rgba(255,255,255,0.06);
      --bdCard:rgba(255,255,255,0.08);
      --glass:rgba(0,0,0,0.35);
      --glass2:rgba(0,0,0,0.28);
    }

    html, body{
      margin:0;
      padding:28px 0 34px; /* ‚úÖ no left/right padding */
      background:transparent !important;
      font-family:'Inter', sans-serif;
      color:var(--text);
      line-height:1.65;
      overflow-x:hidden;
    }

    /* Subtle immersive overlay (very light) */
    body:before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      background:
        radial-gradient(900px 380px at 15% 10%, rgba(25,223,255,0.10), transparent 60%),
        radial-gradient(900px 380px at 85% 20%, rgba(59,196,255,0.08), transparent 60%),
        linear-gradient(to bottom, rgba(0,0,0,0.10), rgba(0,0,0,0.00));
      mix-blend-mode:screen;
      opacity:.9;
    }

    /* Header */
    .wrap{
      width:min(1100px, calc(100% - 64px));
      margin:0 auto;
    }

    .header-badge{
      display:inline-block;
      padding:6px 14px;
      font-size:12px;
      border-radius:20px;
      border:1px solid #2aa8ff;
      color:#2aa8ff;
      margin-bottom:12px;
      letter-spacing:1px;
      text-transform:uppercase;
      background: rgba(0,0,0,0.20);
      backdrop-filter: blur(10px);
      position:relative;
      overflow:hidden;
    }
    .header-badge:after{
      content:"";
      position:absolute;
      top:-40%;
      left:-40%;
      width:60%;
      height:180%;
      background:linear-gradient(90deg, transparent, rgba(25,223,255,0.18), transparent);
      transform:rotate(18deg);
      animation: badgeSweep 4.5s ease-in-out infinite;
    }
    @keyframes badgeSweep{
      0%{ transform:translateX(-120%) rotate(18deg); opacity:0; }
      20%{ opacity:1; }
      55%{ opacity:1; }
      100%{ transform:translateX(260%) rotate(18deg); opacity:0; }
    }

    h1{
      font-family:'Orbitron', sans-serif;
      font-size:42px;
      font-weight:900;
      letter-spacing:3px;
      color:#ffffff;
      margin:0 0 12px 0;
      text-shadow: 0 0 22px rgba(25,223,255,0.12);
    }
    .subtitle{
      max-width:1100px;
      color:#b8dfff;
      margin:0 0 22px 0;
      font-size:15px;
    }

    /* Card */
    #game-container{
      max-width:1100px;
      background:var(--bgCard);
      border:1px solid var(--bdCard);
      border-radius:18px;
      padding:26px 28px;
      backdrop-filter: blur(10px);
      box-shadow: 0 0 20px rgba(0,0,0,0.35);
      position:relative;
      overflow:hidden;
    }

    /* subtle scanline */
    #game-container:before{
      content:"";
      position:absolute;
      inset:-2px;
      pointer-events:none;
      background:
        linear-gradient(to bottom, rgba(255,255,255,0.04), transparent 35%),
        repeating-linear-gradient(
          to bottom,
          rgba(255,255,255,0.02) 0px,
          rgba(255,255,255,0.02) 1px,
          transparent 3px,
          transparent 7px
        );
      opacity:.22;
      mix-blend-mode:overlay;
      animation: scan 6.5s linear infinite;
    }
    @keyframes scan{
      0%{ transform:translateY(-18px); }
      100%{ transform:translateY(18px); }
    }

    /* Story panel (animated) */
    .panel{
      opacity:1;
      transform: translateY(0);
      transition: opacity 320ms ease, transform 320ms ease;
      position:relative;
      z-index:2;
    }
    .panel.is-leaving{ opacity:0; transform: translateY(14px); }
    .panel.is-entering{ opacity:0; transform: translateY(-14px); }
    .panel.is-entered{ opacity:1; transform: translateY(0); }

    /* ‚úÖ Make the question area more visible */
    .step-title{
      font-family:'Orbitron', sans-serif;
      font-size:26px;            /* bigger */
      letter-spacing:2px;
      color:var(--cyan2);
      text-transform:uppercase;
      margin:0 0 10px 0;
      text-shadow: 0 0 18px rgba(59,196,255,0.18);
    }
    .step-desc{
      margin:0;
      font-size:16px;            /* more visible */
      color:#e7f2ff;             /* brighter than before */
      opacity:0.98;
    }

    /* Checkpoint / outcome card (intermediate / end) */
    .checkpoint{
      margin-top:14px;
      background: rgba(0,0,0,0.34);
      border:1px solid rgba(59,196,255,0.22);
      border-radius:14px;
      padding:12px 14px;
      backdrop-filter: blur(10px);
      box-shadow: 0 0 18px rgba(25,223,255,0.10);
    }
    .checkpoint-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:8px;
    }
    .checkpoint-badge{
      font-family:'Orbitron', sans-serif;
      font-size:12px;
      letter-spacing:1.2px;
      text-transform:uppercase;
      color:#ffffff;
      opacity:0.92;
    }
    .checkpoint-kpis{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
      color:#bfe6ff;
      font-weight:700;
      font-size:13px;
    }
    .kpi{
      display:inline-flex;
      align-items:center;
      gap:6px;
      background: rgba(0,0,0,0.22);
      border:1px solid rgba(255,255,255,0.07);
      padding:7px 10px;
      border-radius:12px;
    }
    .checkpoint-text{
      margin:0;
      color:#d9edff;
      font-size:14px;
      line-height:1.55;
      opacity:0.98;
    }

    /* Choices */
    #choices{
      margin-top:18px;
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
      position:relative;
      z-index:2;
    }
    @media (min-width: 860px){
      #choices{ grid-template-columns: 1fr 1fr; }
    }

    /* ‚úÖ Bigger, cleaner answers (no subtext) */
    .choice-btn{
      width:100%;
      border:1px solid rgba(59,196,255,0.42);
      background: rgba(0,0,0,0.34);
      color:#ffffff;
      border-radius:16px;
      padding:18px 18px;
      cursor:pointer;
      font-size:17px;     /* bigger */
      font-weight:800;    /* bolder */
      letter-spacing:0.2px;
      text-align:left;
      transition: 0.22s ease;
      backdrop-filter: blur(10px);
      position:relative;
      overflow:hidden;
    }
    .choice-btn:after{
      content:"";
      position:absolute;
      inset:-2px;
      background: radial-gradient(240px 120px at 20% 10%, rgba(25,223,255,0.14), transparent 60%);
      opacity:0;
      transition: .22s ease;
    }
    .choice-btn:hover{
      transform: translateY(-2px);
      border-color: rgba(59,196,255,0.78);
      box-shadow: 0 0 20px rgba(59,196,255,0.18);
    }
    .choice-btn:hover:after{ opacity:1; }

    /* Stats */
    #stats{
      margin-top:22px;
      padding-top:14px;
      border-top:1px solid rgba(255,255,255,0.12);
      display:flex;
      flex-wrap:wrap;
      gap:10px 18px;
      justify-content:space-between;
      position:relative;
      z-index:2;
    }
    .stat{
      background: var(--glass2);
      border:1px solid rgba(255,255,255,0.08);
      border-radius:14px;
      padding:11px 12px;
      min-width: 240px;
      backdrop-filter: blur(10px);
      font-weight:700;
    }
    .stat b{ color:var(--cyan2); letter-spacing:0.2px; }

    /* Final score card */
    .score-card{
      margin-top:18px;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(59,196,255,0.35);
      border-radius: 16px;
      padding: 16px 18px;
      backdrop-filter: blur(12px);
      position:relative;
      z-index:2;
    }
    .score-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
    }
    .score-label{
      font-family:'Orbitron', sans-serif;
      letter-spacing:2px;
      text-transform:uppercase;
      color:#ffffff;
      opacity:0.9;
      font-size:13px;
      margin:0 0 6px 0;
    }
    .score-value{
      font-family:'Orbitron', sans-serif;
      font-size:36px;
      font-weight:900;
      letter-spacing:3px;
      color:var(--cyan);
      margin:0;
      text-shadow: 0 0 18px rgba(25,223,255,0.20);
    }

    /* ‚úÖ Final button on the right, blue DA, white text, new tab */
    .final-cta{
      margin-left:auto;
      display:flex;
      justify-content:flex-end;
      align-items:center;
    }
    .btn-enter{
      display:inline-block;
      text-decoration:none;
      font-family:'Orbitron', sans-serif;
      font-size:16px;
      font-weight:900;
      letter-spacing:2px;
      text-transform:uppercase;
      padding:14px 22px;
      border-radius:16px;
      background:var(--cyan);
      color:#ffffff; /* ‚úÖ white text */
      border:1px solid rgba(25,223,255,0.55);
      transition: 0.22s ease;
      white-space:nowrap;
      box-shadow: 0 0 0 rgba(25,223,255,0);
    }
    .btn-enter:hover{
      background:#4be9ff;
      transform: translateY(-2px);
      box-shadow: 0 0 18px rgba(25,223,255,0.26);
    }

    /* Modal */
    .modal-overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,0.58);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 22px;
      z-index:9999;
    }
    .modal{
      width: min(740px, 100%);
      background: rgba(10,20,35,0.86);
      border:1px solid rgba(255,255,255,0.10);
      border-radius: 18px;
      padding: 18px 18px 14px 18px;
      backdrop-filter: blur(14px);
      box-shadow: 0 0 30px rgba(0,0,0,0.50);
    }
    .modal h3{
      margin:0 0 10px 0;
      font-family:'Orbitron', sans-serif;
      color:#ffffff;
      letter-spacing:2px;
      text-transform:uppercase;
      font-size:16px;
    }
    .modal p{
      margin:0 0 14px 0;
      color:#d4e7ff;
      font-size:14px;
      line-height:1.6;
    }
    .modal-actions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .modal-btn{
      border:1px solid rgba(255,255,255,0.12);
      border-radius: 14px;
      padding: 10px 14px;
      font-weight:900;
      cursor:pointer;
      transition: 0.2s ease;
      font-family:'Orbitron', sans-serif;
      letter-spacing:1px;
      text-transform:uppercase;
      color:#fff;
    }
    .modal-btn.primary{
      background:var(--cyan);
      border-color: rgba(25,223,255,0.55);
    }
    .modal-btn.primary:hover{ transform: translateY(-1px); background:#4be9ff; }
    .modal-btn.secondary{
      background: rgba(0,0,0,0.25);
      border-color: rgba(59,196,255,0.35);
    }
    .modal-btn.secondary:hover{ transform: translateY(-1px); border-color: rgba(59,196,255,0.75); }

    /* small enter animation for the whole container */
    .enterAnim{
      animation: enter 520ms ease-out both;
    }
    @keyframes enter{
      from{ opacity:0; transform: translateY(14px); }
      to{ opacity:1; transform: translateY(0); }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header-badge">Mission: Connected Heroes ¬∑ The Practice</div>
    <h1>Interactive Simulation</h1>
    <p class="subtitle">
      Make your choices step by step. Each decision impacts your <b>time</b>, your <b>battery</b> and your <b>progress</b>.
    </p>

    <main id="game-container" class="enterAnim">
      <section id="story" class="panel" aria-live="polite"></section>
      <section id="choices"></section>

      <aside id="stats">
        <div class="stat">‚è± Time : <b><span id="time">00:00</span></b></div>
        <div class="stat">üîã Battery : <b><span id="battery">50</span></b>%</div>
        <div class="stat">üìç Progress : <b><span id="progress">0</span></b> / 1000 km</div>
      </aside>

      <div id="finalScore" style="display:none;"></div>
    </main>
  </div>

  <!-- Modal -->
  <div id="modalOverlay" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <h3 id="modalTitle">Decision</h3>
      <p id="modalText"></p>
      <div class="modal-actions">
        <button id="modalNo" class="modal-btn secondary" type="button">No</button>
        <button id="modalYes" class="modal-btn primary" type="button">Yes</button>
      </div>
    </div>
  </div>

  <script>
    /* ==========================================================
      NOTE
      This version focuses on:
      - bigger question & answers
      - intermediate checkpoint/outcome cards
      - immersive transitions
      - clean answers (no subtext)
      - ENTER THE CODE final CTA (new tab)
      - time never negative
    ========================================================== */

    const TOTAL_KM = 1000;

    // State
    let battery = 50;       // %
    let timeMin = 0;        // minutes (never negative)
    let kmDone  = 0;        // progress
    let prep = "50";        // "50" | "80" | "100"
    let gps = "eVrouting";  // "Google Maps" | "eRoute" | "eVrouting"
    let driving = "Balanced"; // "Eco" | "Balanced" | "Sport"
    let usedMyBrand = null; // true | false
    let branchFlags = {
      breakdown:false,
      tireIssue:false,
      calledCenter:false,
      lostInCorridors:false,
      roadsideAssistance:false
    };

    function clampState(){
      if (timeMin < 0) timeMin = 0;
      battery = Math.max(0, Math.min(100, Math.round(battery)));
      kmDone  = Math.max(0, Math.min(TOTAL_KM, Math.round(kmDone)));
    }

    function minutesToHHMM(m){
      const mm = Math.max(0, Math.round(m));
      const h = Math.floor(mm / 60);
      const r = mm % 60;
      return `${String(h).padStart(2,"0")}:${String(r).padStart(2,"0")}`;
    }

    function updateStats(){
      clampState();
      document.getElementById("battery").textContent = battery;
      document.getElementById("time").textContent = minutesToHHMM(timeMin);
      document.getElementById("progress").textContent = kmDone;
      sendHeightDelayed();
    }

    function transitionTo(html){
      const story = document.getElementById("story");
      story.classList.add("is-leaving");
      setChoices([]);

      setTimeout(() => {
        story.classList.remove("is-leaving");
        story.classList.add("is-entering");
        story.innerHTML = html;

        requestAnimationFrame(() => {
          story.classList.add("is-entered");
          story.classList.remove("is-entering");
          setTimeout(() => story.classList.remove("is-entered"), 320);
        });

        sendHeightDelayed();
      }, 260);
    }

    function setStory(html){
      document.getElementById("story").innerHTML = html;
      sendHeightDelayed();
    }

    function setChoices(choices){
      const container = document.getElementById("choices");
      container.innerHTML = "";

      choices.forEach(choice => {
        const btn = document.createElement("button");
        btn.className = "choice-btn";
        btn.type = "button";
        btn.textContent = choice.label;
        btn.addEventListener("click", choice.action);
        container.appendChild(btn);
      });

      sendHeightDelayed();
    }

    function checkpointCard({ title="CHECKPOINT", text="", time=minutesToHHMM(timeMin), bat=battery, prog=kmDone }){
      return `
        <div class="checkpoint">
          <div class="checkpoint-head">
            <div class="checkpoint-badge">${title}</div>
            <div class="checkpoint-kpis">
              <span class="kpi">‚è± ${time}</span>
              <span class="kpi">üîã ${bat}%</span>
              <span class="kpi">üìç ${prog}/${TOTAL_KM} km</span>
            </div>
          </div>
          ${text ? `<p class="checkpoint-text">${text}</p>` : ``}
        </div>
      `;
    }

    /* Modal helper */
    function askModal({ title, text, yesLabel="Yes", noLabel="No" }){
      return new Promise(resolve => {
        const overlay = document.getElementById("modalOverlay");
        const t = document.getElementById("modalTitle");
        const p = document.getElementById("modalText");
        const yes = document.getElementById("modalYes");
        const no = document.getElementById("modalNo");

        t.textContent = title;
        p.textContent = text;
        yes.textContent = yesLabel;
        no.textContent = noLabel;

        overlay.style.display = "flex";
        overlay.setAttribute("aria-hidden", "false");

        const cleanup = () => {
          overlay.style.display = "none";
          overlay.setAttribute("aria-hidden", "true");
          yes.onclick = null;
          no.onclick = null;
        };

        yes.onclick = () => { cleanup(); resolve(true); };
        no.onclick  = () => { cleanup(); resolve(false); };

        sendHeightDelayed();
      });
    }

    /* SCORE (kept simple + never negative) */
    function computeScore(){
      // base 1000
      // time penalty capped
      // battery bonus
      const base = 1000;

      // ‚Äúbuffer‚Äù so users don‚Äôt go instantly negative
      const buffer = 120; // first 2h are ‚Äúfree‚Äù
      const effective = Math.max(0, timeMin - buffer);
      const timePenalty = Math.min(900, Math.round(effective * 1.05)); // capped

      const batteryBonus = Math.round((battery / 100) * 250);
      const score = Math.max(0, base - timePenalty + batteryBonus);
      return { score };
    }

    function showFinalScore(){
      const { score } = computeScore();
      const wrap = document.getElementById("finalScore");
      wrap.style.display = "block";
      wrap.innerHTML = `
        <div class="score-card">
          <div class="score-top">
            <div>
              <p class="score-value">${score}</p>
            </div>

            <div class="final-cta">
              <a class="btn-enter"
                 href="https://forms.cloud.microsoft/e/iHrWwNt9Bt"
                 target="_blank" rel="noopener">
                ENTER THE CODE
              </a>
            </div>
          </div>
        </div>
      `;
      sendHeightDelayed();
    }

    /* ==========================================================
       FULL FLOW (expanded + intermediate/end outcomes)
       - Includes 80/50/100 preparation
       - Multiple end timelines (incl. very late endings)
       - Intermediate ‚Äúoutcome‚Äù cards like your screenshot
    ========================================================== */

    function startGame(){
      battery = 50;
      timeMin = 0;
      kmDone  = 0;

      prep = "50";
      gps = "eVrouting";
      driving = "Balanced";
      usedMyBrand = null;
      branchFlags = {
        breakdown:false,
        tireIssue:false,
        calledCenter:false,
        lostInCorridors:false,
        roadsideAssistance:false
      };

      setStory(`
        <div>
          <div class="step-title">MISSION BRIEFING</div>
          <p class="step-desc">
            Reach the Laboratory while optimizing your energy management and decisions.
          </p>
          ${checkpointCard({ title:"START", text:"Ready to begin the mission simulation.", time:"00:00", bat:50, prog:0 })}
        </div>
      `);

      setChoices([
        { label: "START THE SIMULATION", action: () => stepVehiclePrep() }
      ]);

      updateStats();
    }

    function stepVehiclePrep(){
      transitionTo(`
        <div>
          <div class="step-title">STEP 1 ‚Äì VEHICLE PREPARATION</div>
          <p class="step-desc">Before entering the mission, choose how you prepare your vehicle.</p>
        </div>
      `);

      setChoices([
        { label: "CHARGE TO 80% + PREHEAT CABIN & BATTERY", action: () => {
          prep = "80"; timeMin += 45; battery = 80; kmDone = 0;
          stepCopilot();
        }},
        { label: "LEAVE IMMEDIATELY (50%)", action: () => {
          prep = "50"; /* timeMin += 0 */ battery = 50; kmDone = 0;
          stepCopilot();
        }},
        { label: "CHARGE TO 100% + PREHEAT CABIN & BATTERY", action: () => {
          prep = "100"; timeMin += 135; battery = 100; kmDone = 0;
          stepCopilot();
        }}
      ]);

      updateStats();
    }

    function stepCopilot(){
      transitionTo(`
        <div>
          <div class="step-title">STEP 2 ‚Äì CHOOSE YOUR DIGITAL CO-PILOT</div>
          <p class="step-desc">
            Choose the navigation app you will use for the journey.
          </p>
          ${checkpointCard({ title:"CHECKPOINT", text:"Decision locked: vehicle prepared.", time:minutesToHHMM(timeMin), bat:battery, prog:kmDone })}
        </div>
      `);

      setChoices([
        { label: "GOOGLE MAPS", action: () => { gps="Google Maps"; stepDrivingStyle300(); } },
        { label: "EROUTE", action: () => { gps="eRoute"; stepDrivingStyle300(); } },
        { label: "EVROUTING", action: () => { gps="eVrouting"; stepDrivingStyle300(); } }
      ]);

      updateStats();
    }

    function stepDrivingStyle300(){
      transitionTo(`
        <div>
          <div class="step-title">STEP 3 ‚Äì DRIVING STYLE (FIRST 300 KM)</div>
          <p class="step-desc">
            Choose your driving style for the first <b>300 km</b>.
          </p>
        </div>
      `);

      setChoices([
        { label: "ECO DRIVING", action: () => applyDriving("Eco") },
        { label: "BALANCED DRIVING", action: () => applyDriving("Balanced") },
        { label: "SPORT DRIVING", action: () => applyDriving("Sport") }
      ]);

      function applyDriving(mode){
        driving = mode;

        // Base states inspired by diagram (for 50%). Prep level shifts battery a bit.
        // (We keep the mission coherent + multi timelines, without going negative.)
        const prepBonus = (prep === "100") ? 20 : (prep === "80") ? 10 : 0;

        if (mode === "Eco"){
          timeMin = Math.max(timeMin, 200);
          battery = Math.max(0, 65 + prepBonus);
        }
        if (mode === "Balanced"){
          timeMin = Math.max(timeMin, 165);
          battery = Math.max(0, 45 + prepBonus);
        }
        if (mode === "Sport"){
          timeMin = Math.max(timeMin, 135);
          battery = Math.max(0, 20 + prepBonus);
        }

        kmDone = 300;
        stepStationsChoice();
        updateStats();
      }

      updateStats();
    }

    function stepStationsChoice(){
      transitionTo(`
        <div>
          <div class="step-title">STEP 4 ‚Äì CHARGING STATIONS AHEAD</div>
          <p class="step-desc">
            Two charging stations are available: one in <b>20 km</b>, another in <b>180 km</b>. What do you do?
          </p>
          ${checkpointCard({ title:"STATUS", text:"You are leaving the highway and entering countryside roads.", time:minutesToHHMM(timeMin), bat:battery, prog:kmDone })}
        </div>
      `);

      setChoices([
        { label: "STOP AT THE NEXT STATION (20 KM)", action: () => {
          kmDone = 320;
          // charge to 80%
          battery = 80;
          // adjust timeline by driving
          if (driving === "Balanced") timeMin = Math.max(timeMin, 210);
          if (driving === "Sport")    timeMin = Math.max(timeMin, 210);
          if (driving === "Eco")      timeMin = Math.max(timeMin, 230);
          stepSegment400();
          updateStats();
        }},
        { label: "KEEP GOING (AIM FOR 180 KM)", action: () => {
          if (driving === "Sport"){
            // diagram: breakdown before reaching the station
            branchFlags.breakdown = true;
            stepBreakdown();
            return;
          }
          kmDone = 480;
          battery = 80;
          if (driving === "Balanced") timeMin = Math.max(timeMin, 330);
          if (driving === "Eco")      timeMin = Math.max(timeMin, 350);
          stepSegment400();
          updateStats();
        }}
      ]);

      updateStats();
    }

    function stepBreakdown(){
      transitionTo(`
        <div>
          <div class="step-title">INCIDENT ‚Äì BREAKDOWN</div>
          <p class="step-desc">
            Your vehicle breaks down before you can reach the charging station.
          </p>
          ${checkpointCard({ title:"OUTCOME", text:"Roadside assistance is required to continue.", time:minutesToHHMM(timeMin), bat:battery, prog:kmDone })}
        </div>
      `);

      setChoices([
        { label: "CALL ROADSIDE ASSISTANCE", action: () => {
          branchFlags.roadsideAssistance = true;
          // Heavy time impact (diagram shows 15:05 at 940 in one path; we‚Äôll enforce late path later)
          timeMin = Math.max(timeMin, 905); // 15:05 baseline
          battery = Math.min(battery, 60);
          kmDone = Math.max(kmDone, 940);
          stepSegment400(true);
          updateStats();
        }}
      ]);

      updateStats();
    }

    function stepSegment400(fromBreakdown=false){
      transitionTo(`
        <div>
          <div class="step-title">STEP 5 ‚Äì 400 KM SEGMENT</div>
          <p class="step-desc">
            You must complete a new <b>400 km</b> segment with tunnels and dead zones.
          </p>
          ${checkpointCard({
            title:"CHECKPOINT",
            text:"Navigation performance matters on this stretch.",
            time:minutesToHHMM(timeMin),
            bat:battery,
            prog:kmDone
          })}
        </div>
      `);

      setChoices([
        { label: "CONTINUE", action: () => {
          kmDone = 720;

          // Diagram-like endpoints (with GM malus)
          let endTimeWithGM, endBattery;

          if (driving === "Balanced") { endTimeWithGM = 415; endBattery = 30; } // 06:55
          if (driving === "Sport")    { endTimeWithGM = 345; endBattery = 10; } // 05:45
          if (driving === "Eco")      { endTimeWithGM = 510; endBattery = 55; } // 08:30

          if (fromBreakdown){
            driving = "Sport";
            endTimeWithGM = Math.max(endTimeWithGM || 345, 1035); // push to very late if roadside branch already applied
            endBattery = 10;
          }

          if (gps === "Google Maps") timeMin = Math.max(timeMin, endTimeWithGM);
          else timeMin = Math.max(timeMin, Math.round(endTimeWithGM / 1.10));

          battery = endBattery;

          stepLongBreakCharge();
          updateStats();
        }}
      ]);

      updateStats();
    }

    function stepLongBreakCharge(){
      transitionTo(`
        <div>
          <div class="step-title">STEP 6 ‚Äì LONG BREAK & CHARGING</div>
          <p class="step-desc">
            You stop at a charging station to rest and recharge before the final stretch.
          </p>
          ${checkpointCard({ title:"STATUS", text:"Charging session begins.", time:minutesToHHMM(timeMin), bat:battery, prog:kmDone })}
        </div>
      `);

      setChoices([
        { label: "USE MY[BRAND] APP", action: () => {
          usedMyBrand = true;

          // Diagram nodes ‚ÄúYes‚Äù -> 80% at 720 km
          if (driving === "Balanced") { timeMin = Math.max(timeMin, 475); battery = 80; } // 07:55
          if (driving === "Sport")    { timeMin = Math.max(timeMin, 495); battery = 80; } // 08:15
          if (driving === "Eco")      { timeMin = Math.max(timeMin, 555); battery = 80; } // 09:15

          stepTireAlert();
          updateStats();
        }},
        { label: "CHARGE WITHOUT THE APP", action: () => {
          usedMyBrand = false;

          // Diagram nodes ‚ÄúNo‚Äù -> 85% at 720 km (+30 min malus)
          if (driving === "Balanced") { timeMin = Math.max(timeMin, 505); battery = 85; } // 08:25
          if (driving === "Sport")    { timeMin = Math.max(timeMin, 555); battery = 85; } // 09:15
          if (driving === "Eco")      { timeMin = Math.max(timeMin, 585); battery = 85; } // 09:45

          stepTireAlert();
          updateStats();
        }}
      ]);

      updateStats();
    }

    function stepTireAlert(){
      transitionTo(`
        <div>
          <div class="step-title">STEP 7 ‚Äì TIRE PRESSURE ALERT</div>
          <p class="step-desc">
            At <b>60 km</b> from the finish line, you receive a tire underinflation alert. What do you do?
          </p>
          ${checkpointCard({ title:"ALERT", text:"A wrong choice can end the mission.", time:minutesToHHMM(timeMin), bat:battery, prog:kmDone })}
        </div>
      `);

      setChoices([
        { label: "CALL THE CALL CENTER", action: () => stepCallCenterPath() },
        { label: "KEEP DRIVING", action: () => stepKeepDrivingExplosion() }
      ]);

      updateStats();
    }

    function stepCallCenterPath(){
      branchFlags.calledCenter = true;

      transitionTo(`
        <div>
          <div class="step-title">CALL CENTER SUPPORT</div>
          <p class="step-desc">
            The Call Center helps you locate the next station to reinflate your tires.
          </p>
          ${checkpointCard({
            title:"OUTCOME",
            text:"You lose some time, but you save your tires.",
            time:minutesToHHMM(timeMin),
            bat:battery,
            prog:kmDone
          })}
        </div>
      `);

      setChoices([
        { label: "CONTINUE TO THE LABORATORY", action: async () => {
          // Some diagram outcomes include (malus 30 minutes + 15 min)
          // We apply them here as an ‚Äúintermediate‚Äù milestone card before ending.
          timeMin += 30; // malus
          const lost = await askModal({
            title:"Navigation inside the building",
            text:"Once you arrive, do you get lost in the corridors?",
            yesLabel:"Yes",
            noLabel:"No"
          });
          if (lost){
            branchFlags.lostInCorridors = true;
            timeMin += 15;
          }

          // Final outcomes (multiple timelines)
          kmDone = 1000;

          // Use diagram-like endpoints (we keep the variety requested: 11:25 / 13:25 / 16:35 / +24h)
          // We enforce ‚Äúlate‚Äù endings for roadside/breakdown and for specific combos.
          if (branchFlags.roadsideAssistance){
            // very late path (+24h / extreme delay)
            timeMin = Math.max(timeMin, 24*60 + 35); // 24h35
            battery = Math.min(battery, 20);
          } else {
            if (driving === "Eco")      { timeMin = Math.max(timeMin, 685); battery = 35; } // 11:25
            if (driving === "Balanced") { timeMin = Math.max(timeMin, 805); battery = 50; } // 13:25
            if (driving === "Sport")    { timeMin = Math.max(timeMin, 710); battery = 25; } // 11:50

            // Add an extra late timeline variant (ex: 16:35) depending on earlier decisions
            if (gps === "Google Maps" && usedMyBrand === false){
              timeMin = Math.max(timeMin, 995); // 16:35
              battery = Math.min(50, battery);
            }
          }

          endWin();
          updateStats();
        }}
      ]);

      updateStats();
    }

    function stepKeepDrivingExplosion(){
      branchFlags.tireIssue = true;

      transitionTo(`
        <div>
          <div class="step-title">CRITICAL FAILURE</div>
          <p class="step-desc">
            Your tire explodes. You can‚Äôt keep driving.
          </p>
          ${checkpointCard({
            title:"OUTCOME",
            text:"The mission cannot be completed.",
            time:minutesToHHMM(timeMin),
            bat:battery,
            prog:kmDone
          })}
        </div>
      `);

      setChoices([
        { label: "CALL YOUR INSURANCE", action: () => endLose() }
      ]);

      updateStats();
    }

    function endWin(){
      updateStats();

      transitionTo(`
        <div>
          <div class="step-title">MISSION COMPLETED</div>
          <p class="step-desc">
            Congratulations Hero. You reached the Laboratory.
          </p>
        </div>
      `);

      setChoices([]);
      showFinalScore();
    }

    function endLose(){
      updateStats();

      transitionTo(`
        <div>
          <div class="step-title">MISSION FAILED</div>
          <p class="step-desc">
            YOU LOSE ‚Äî you didn‚Äôt make it to the Laboratory.
          </p>
          ${checkpointCard({
            title:"FINAL STATUS",
            text:"Restart and optimize your choices to improve your result.",
            time:minutesToHHMM(timeMin),
            bat:battery,
            prog:kmDone
          })}
        </div>
      `);

      // As requested: at the end, only Enter the code on success.
      setChoices([
        { label: "RESTART SIMULATION", action: () => startGame() }
      ]);

      document.getElementById("finalScore").style.display = "none";
      sendHeightDelayed();
    }

    /* SharePoint iframe resize */
    function sendHeight(){
      const height = document.documentElement.scrollHeight;
      parent.postMessage({ type: "resizePracticeSim", height }, "*");
    }
    function sendHeightDelayed(){ setTimeout(sendHeight, 260); }

    window.addEventListener("load", () => { sendHeight(); setInterval(sendHeight, 900); });
    window.addEventListener("resize", sendHeight);

    startGame();
  </script>
</body>
</html>
