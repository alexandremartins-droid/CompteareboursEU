<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mission 2 ‚Äì The Practice (Interactive Simulation)</title>

  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;600;700;900&family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>
    html, body{
      margin:0;
      padding:28px 0 40px; /* ‚úÖ no left/right padding */
      background:transparent !important;
      font-family:'Inter', sans-serif;
      color:#d4e7ff;
      line-height:1.65;
    }

    /* Header */
    .header-badge{
      display:inline-block;
      padding:6px 14px;
      font-size:12px;
      border-radius:20px;
      border:1px solid #2aa8ff;
      color:#2aa8ff;
      margin:0 0 12px 0;
      letter-spacing:1px;
      text-transform:uppercase;
      background: rgba(0,0,0,0.20);
      backdrop-filter: blur(10px);
    }
    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:0 0; /* ‚úÖ keep 0 */
    }
    h1{
      font-family:'Orbitron', sans-serif;
      font-size:40px;
      font-weight:800;
      letter-spacing:3px;
      color:#ffffff;
      margin:0 0 14px 0;
    }
    .subtitle{
      max-width:1100px;
      color:#b8dfff;
      margin:0 0 22px 0;
      font-size:15px;
    }

    /* Card */
    #game-container{
      max-width:1100px;
      background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.08);
      border-radius:18px;
      padding:26px 26px;
      backdrop-filter: blur(10px);
      box-shadow: 0 0 20px rgba(0,0,0,0.35);
    }

    /* Panel transition */
    .panel{
      opacity:1;
      transform: translateY(0);
      transition: opacity 300ms ease, transform 300ms ease;
    }
    .panel.is-leaving{ opacity:0; transform: translateY(14px); }
    .panel.is-entering{ opacity:0; transform: translateY(-14px); }
    .panel.is-entered{ opacity:1; transform: translateY(0); }

    /* Story typography */
    #story h2{
      font-family:'Orbitron', sans-serif;
      font-size:22px; /* ‚úÖ bigger question */
      letter-spacing:2px;
      color:#3bc4ff;
      text-transform:uppercase;
      margin:0 0 10px 0;
    }
    #story p{
      margin:0 0 10px 0;
      font-size:16px; /* ‚úÖ bigger text */
      color:#d4e7ff;
    }
    .meta{
      margin-top:10px;
      font-size:13px;
      color:#9ed8ff;
      opacity:0.95;
    }

    /* Choices */
    #choices{
      margin-top:18px;
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 860px){
      #choices{ grid-template-columns: 1fr 1fr; }
    }

    .choice-btn{
      width:100%;
      border:1px solid rgba(59,196,255,0.45);
      background: rgba(0,0,0,0.35);
      color:#ffffff;
      border-radius:16px;
      padding:18px 18px; /* ‚úÖ bigger */
      cursor:pointer;
      font-size:16px;    /* ‚úÖ bigger */
      font-weight:800;
      letter-spacing:0.2px;
      text-align:left;
      transition: 0.22s ease;
      backdrop-filter: blur(10px);
      position:relative;
      overflow:hidden;
    }
    .choice-btn:hover{
      transform: translateY(-2px);
      border-color: rgba(59,196,255,0.85);
      box-shadow: 0 0 18px rgba(59,196,255,0.18);
    }
    .choice-btn::after{
      content:"";
      position:absolute;
      inset:-40%;
      background: radial-gradient(circle at 20% 20%, rgba(25,223,255,0.18), transparent 55%);
      opacity:0;
      transition: 0.22s ease;
      pointer-events:none;
    }
    .choice-btn:hover::after{ opacity:1; }

    .choice-sub{
      margin-top:8px;
      font-size:13px;
      font-weight:600;
      color:#b8dfff;
      opacity:0.95;
    }

    /* Stats */
    #stats{
      margin-top:22px;
      padding-top:14px;
      border-top:1px solid rgba(255,255,255,0.12);
      display:flex;
      flex-wrap:wrap;
      gap:10px 18px;
      justify-content:space-between;
    }
    .stat{
      background: rgba(0,0,0,0.28);
      border:1px solid rgba(255,255,255,0.08);
      border-radius:14px;
      padding:10px 12px;
      min-width: 240px;
      backdrop-filter: blur(10px);
      font-size:14px;
    }
    .stat b{ color:#3bc4ff; letter-spacing:0.2px; }

    /* Final score card */
    .score-card{
      margin-top:18px;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(59,196,255,0.35);
      border-radius: 16px;
      padding: 16px 18px;
      backdrop-filter: blur(12px);
      animation: popIn 280ms ease both;
    }
    @keyframes popIn{
      from{ opacity:0; transform: translateY(10px); }
      to{ opacity:1; transform: translateY(0); }
    }

    .score-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
    }
    .score-value{
      font-family:'Orbitron', sans-serif;
      font-size:34px;
      font-weight:900;
      letter-spacing:3px;
      color:#19dfff;
      margin:0;
    }
    .score-line{
      margin:8px 0 0 0;
      color:#b8dfff;
      font-size:14px;
      line-height:1.6;
    }

    /* Final button (DA) */
    .final-cta{
      margin-left:auto;
      display:flex;
      justify-content:flex-end;
      align-items:flex-start;
    }
    .btn-enter{
      display:inline-block;
      text-decoration:none;
      font-family:'Orbitron', sans-serif;
      font-size:16px;
      font-weight:900;
      letter-spacing:2px;
      text-transform:uppercase;
      padding:14px 22px;
      border-radius:16px;
      background:#19dfff;
      color:#062035;
      border:1px solid rgba(25,223,255,0.55);
      transition: 0.22s ease;
      white-space:nowrap;
      position:relative;
      overflow:hidden;
    }
    .btn-enter::after{
      content:"";
      position:absolute;
      inset:0;
      background: linear-gradient(110deg, transparent 0%, rgba(255,255,255,0.35) 45%, transparent 70%);
      transform: translateX(-140%);
      transition: transform 0.55s ease;
      opacity:0.55;
    }
    .btn-enter:hover{
      background:#4be9ff;
      transform: translateY(-2px);
      box-shadow: 0 0 18px rgba(25,223,255,0.22);
    }
    .btn-enter:hover::after{
      transform: translateX(140%);
    }

    /* Modal */
    .modal-overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 22px;
      z-index:9999;
    }
    .modal{
      width: min(720px, 100%);
      background: rgba(10,20,35,0.85);
      border:1px solid rgba(255,255,255,0.10);
      border-radius: 18px;
      padding: 18px 18px 14px 18px;
      backdrop-filter: blur(14px);
      box-shadow: 0 0 30px rgba(0,0,0,0.50);
      animation: popIn 260ms ease both;
    }
    .modal h3{
      margin:0 0 10px 0;
      font-family:'Orbitron', sans-serif;
      color:#ffffff;
      letter-spacing:2px;
      text-transform:uppercase;
      font-size:16px;
    }
    .modal p{
      margin:0 0 14px 0;
      color:#d4e7ff;
      font-size:14px;
      line-height:1.6;
    }
    .modal-actions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .modal-btn{
      border:1px solid rgba(255,255,255,0.12);
      border-radius: 14px;
      padding: 10px 14px;
      font-weight:900;
      cursor:pointer;
      transition: 0.2s ease;
      font-family:'Orbitron', sans-serif;
      letter-spacing:1px;
      text-transform:uppercase;
    }
    .modal-btn.primary{
      background:#19dfff;
      color:#062035;
      border-color: rgba(25,223,255,0.55);
    }
    .modal-btn.primary:hover{ transform: translateY(-1px); background:#4be9ff; }
    .modal-btn.secondary{
      background: rgba(0,0,0,0.25);
      color:#ffffff;
      border-color: rgba(59,196,255,0.35);
    }
    .modal-btn.secondary:hover{ transform: translateY(-1px); border-color: rgba(59,196,255,0.75); }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header-badge">Mission: Connected Heroes ¬∑ The Practice</div>
    <h1>Interactive Simulation</h1>
    <p class="subtitle">
      Make your choices step by step. Each decision impacts your <b>time</b>, your <b>battery</b> and your <b>progress</b>.
    </p>

    <main id="game-container">
      <section id="story" class="panel" aria-live="polite"></section>
      <section id="choices"></section>

      <aside id="stats">
        <div class="stat">‚è± Time : <b><span id="time">00:00</span></b></div>
        <div class="stat">üîã Battery : <b><span id="battery">50</span></b>%</div>
        <div class="stat">üìç Progress : <b><span id="progress">0</span></b> / 1000 km</div>
      </aside>

      <div id="finalScore" style="display:none;"></div>
    </main>
  </div>

  <!-- Modal -->
  <div id="modalOverlay" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <h3 id="modalTitle">Decision</h3>
      <p id="modalText"></p>
      <div class="modal-actions">
        <button id="modalNo" class="modal-btn secondary" type="button">No</button>
        <button id="modalYes" class="modal-btn primary" type="button">Yes</button>
      </div>
    </div>
  </div>

  <script>
    /* =========================
       GAME STATE (diagram-driven)
    ========================= */
    const TOTAL_KM = 1000;

    let battery = 50;        // %
    let timeMin = 0;         // total minutes (never negative)
    let kmDone = 0;          // progress

    let prep = "50";         // "50" | "80" | "100"
    let gps = "EVR";         // "GM" | "ER" | "EVR"
    let driving = "BAL";     // "ECO" | "BAL" | "SPT"
    let usedMyBrand = null;  // true | false

    /* =========================
       HELPERS
    ========================= */
    function clampState(){
      if (timeMin < 0) timeMin = 0;
      battery = Math.max(0, Math.min(100, Math.round(battery)));
      kmDone = Math.max(0, Math.min(TOTAL_KM, Math.round(kmDone)));
    }

    function minutesToHHMM(m){
      const mm = Math.max(0, Math.round(m));
      const h = Math.floor(mm / 60);
      const r = mm % 60;
      return `${String(h).padStart(2,"0")}:${String(r).padStart(2,"0")}`;
    }

    function updateStats(){
      clampState();
      document.getElementById("battery").textContent = battery;
      document.getElementById("time").textContent = minutesToHHMM(timeMin);
      document.getElementById("progress").textContent = kmDone;
      sendHeightDelayed();
    }

    function transitionTo(html){
      const story = document.getElementById("story");
      story.classList.add("is-leaving");
      setChoices([]);

      setTimeout(() => {
        story.classList.remove("is-leaving");
        story.classList.add("is-entering");
        story.innerHTML = html;

        requestAnimationFrame(() => {
          story.classList.add("is-entered");
          story.classList.remove("is-entering");
          setTimeout(() => story.classList.remove("is-entered"), 300);
        });

        sendHeightDelayed();
      }, 240);
    }

    function setStory(html){
      document.getElementById("story").innerHTML = html;
      sendHeightDelayed();
    }

    function setChoices(choices){
      const container = document.getElementById("choices");
      container.innerHTML = "";

      choices.forEach(choice => {
        const btn = document.createElement("button");
        btn.className = "choice-btn";
        btn.type = "button";
        btn.textContent = choice.label;

        if (choice.subtext){
          const sub = document.createElement("div");
          sub.className = "choice-sub";
          sub.textContent = choice.subtext;
          btn.appendChild(sub);
        }

        btn.addEventListener("click", choice.action);
        container.appendChild(btn);
      });

      sendHeightDelayed();
    }

    /* =========================
       MODAL
    ========================= */
    function askModal({ title, text, yesLabel="Yes", noLabel="No" }){
      return new Promise(resolve => {
        const overlay = document.getElementById("modalOverlay");
        const t = document.getElementById("modalTitle");
        const p = document.getElementById("modalText");
        const yes = document.getElementById("modalYes");
        const no = document.getElementById("modalNo");

        t.textContent = title;
        p.textContent = text;
        yes.textContent = yesLabel;
        no.textContent = noLabel;

        overlay.style.display = "flex";
        overlay.setAttribute("aria-hidden", "false");

        const cleanup = () => {
          overlay.style.display = "none";
          overlay.setAttribute("aria-hidden", "true");
          yes.onclick = null;
          no.onclick = null;
        };

        yes.onclick = () => { cleanup(); resolve(true); };
        no.onclick  = () => { cleanup(); resolve(false); };

        sendHeightDelayed();
      });
    }

    /* =========================
       SCORE (stable, never negative)
    ========================= */
    function computeScore(){
      // Faster + higher battery => better score
      // Time penalty is capped so it won't go negative.
      const base = 1000;
      const timePenalty = Math.min(900, Math.round(Math.max(0, timeMin - 120) * 1.05));
      const batteryBonus = Math.round((battery / 100) * 250);
      const score = Math.max(0, base - timePenalty + batteryBonus);
      return { score, timePenalty, batteryBonus };
    }

    function showFinalScore(){
      const { score } = computeScore();
      const wrap = document.getElementById("finalScore");
      wrap.style.display = "block";
      wrap.innerHTML = `
        <div class="score-card">
          <div class="score-top">
            <div>
              <p class="score-value">${score}</p>
              <p class="score-line">Final time: <b>${minutesToHHMM(timeMin)}</b> ¬∑ Battery: <b>${battery}%</b></p>
            </div>

            <div class="final-cta">
              <a class="btn-enter" href="https://forms.cloud.microsoft/e/iHrWwNt9Bt" target="_blank" rel="noopener">
                ENTER THE CODE
              </a>
            </div>
          </div>
        </div>
      `;
      sendHeightDelayed();
    }

    /* =========================
       COPILOT MALUS (diagram note)
       GM = +10% / e-Routes = +5% / EVR = 0%
    ========================= */
    function applyCopilotMalusOnSegment(segmentMinutes){
      const m = Math.max(0, segmentMinutes);
      const rate = (gps === "GM") ? 0.10 : (gps === "ER") ? 0.05 : 0.0;
      return Math.round(m * (1 + rate));
    }

    /* =========================
       PATH (full logic)
    ========================= */

    function startGame(){
      battery = 50;
      timeMin = 0;
      kmDone = 0;

      prep = "50";
      gps = "EVR";
      driving = "BAL";
      usedMyBrand = null;

      document.getElementById("finalScore").style.display = "none";

      setStory(`
        <h2>Mission Briefing</h2>
        <p>Your goal: reach the Laboratory as fast as possible while optimizing energy.</p>
        <p class="meta">Start: <b>00:00</b> ¬∑ <b>50%</b> ¬∑ <b>0/1000 km</b></p>
      `);

      setChoices([
        { label: "Start the simulation", subtext: "Begin Mission 2 ‚Äì The Practice.", action: () => stepVehiclePrep() }
      ]);

      updateStats();
    }

    function stepVehiclePrep(){
      transitionTo(`
        <h2>Step 1 ‚Äì Vehicle preparation</h2>
        <p>Before entering the mission, decide how to prepare your vehicle.</p>
      `);

      setChoices([
        {
          label: "Charge to 80% + preheat cabin & battery",
          subtext: "Safer start, costs time.",
          action: () => {
            prep = "80";
            timeMin = 45; battery = 80; kmDone = 0;
            stepCopilot();
          }
        },
        {
          label: "Leave immediately (50%)",
          subtext: "No time lost‚Ä¶ but riskier later.",
          action: () => {
            prep = "50";
            timeMin = 0; battery = 50; kmDone = 0;
            stepCopilot();
          }
        },
        {
          label: "Charge to 100% + preheat cabin & battery",
          subtext: "Maximum energy, very costly in time.",
          action: () => {
            prep = "100";
            timeMin = 135; battery = 100; kmDone = 0;
            stepCopilot();
          }
        }
      ]);

      updateStats();
    }

    function stepCopilot(){
      transitionTo(`
        <h2>Step 2 ‚Äì Choose your digital co-pilot</h2>
        <p>Choose the app you will use to reach the Laboratory.</p>
      `);

      setChoices([
        { label: "Google Maps", subtext: "Copilot malus later: +10% time on the dead-zones segment.", action: () => { gps = "GM"; stepDrivingStyle300(); } },
        { label: "e-Routes", subtext: "Copilot malus later: +5% time on the dead-zones segment.", action: () => { gps = "ER"; stepDrivingStyle300(); } },
        { label: "EV Routing", subtext: "No copilot malus on the dead-zones segment.", action: () => { gps = "EVR"; stepDrivingStyle300(); } }
      ]);

      updateStats();
    }

    function stepDrivingStyle300(){
      transitionTo(`
        <h2>Step 3 ‚Äì Driving style (300 km)</h2>
        <p>You enter a long 300 km stretch. Your driving style affects time and energy.</p>
      `);

      setChoices([
        {
          label: "Eco driving",
          subtext: "Lower energy consumption, slower.",
          action: () => {
            driving = "ECO";
            if (prep === "50"){ timeMin = 200; battery = 65; }
            if (prep === "80"){ timeMin = 245; battery = 65; }
            if (prep === "100"){ timeMin = 335; battery = 85; }
            kmDone = 300;
            stepStationsChoice();
          }
        },
        {
          label: "Balanced driving",
          subtext: "Best overall compromise.",
          action: () => {
            driving = "BAL";
            if (prep === "50"){ timeMin = 165; battery = 45; }
            if (prep === "80"){ timeMin = 210; battery = 45; }
            if (prep === "100"){ timeMin = 300; battery = 65; }
            kmDone = 300;
            stepStationsChoice();
          }
        },
        {
          label: "Sport driving",
          subtext: "Faster, much higher consumption.",
          action: () => {
            driving = "SPT";
            if (prep === "50"){ timeMin = 135; battery = 20; }
            if (prep === "80"){ timeMin = 165; battery = 20; }
            if (prep === "100"){ timeMin = 255; battery = 40; }
            kmDone = 300;
            stepStationsChoice();
          }
        }
      ]);

      updateStats();
    }

    function stepStationsChoice(){
      transitionTo(`
        <h2>Step 4 ‚Äì Countryside road & charging stations</h2>
        <p>You exit the highway. Two charging stations are available: one in <b>20 km</b>, another in <b>180 km</b>.</p>
      `);

      setChoices([
        {
          label: "Stop at the next station (20 km)",
          subtext: "Short stop + charging (safer choice).",
          action: () => {
            kmDone = 320;

            // Diagram-aligned states
            if (prep === "50"){
              battery = 80;
              if (driving === "BAL") timeMin = 210;   // 03:30
              if (driving === "SPT") timeMin = 210;   // 03:30
              if (driving === "ECO") timeMin = 230;   // 03:50
            }

            if (prep === "80"){
              battery = 80;
              if (driving === "BAL") timeMin = 255;   // 04:15
              if (driving === "SPT") timeMin = 210;   // 03:30 (as per provided branch)
              if (driving === "ECO") timeMin = 350;   // 05:50 (as per provided branch)
            }

            if (prep === "100"){
              if (driving === "ECO"){ battery = 100; timeMin = 380; } // 06:20
              else { battery = 80; }
              if (driving === "BAL") timeMin = 345;   // 05:45
              if (driving === "SPT") timeMin = 300;   // 05:00
            }

            stepDeadZonesSegment();
          }
        },
        {
          label: "Keep going (aim for the station at 180 km)",
          subtext: "No immediate stop‚Ä¶ higher risk.",
          action: () => {
            // Sport + prep 50/80 => breakdown (diagram)
            if (driving === "SPT" && (prep === "50" || prep === "80")){
              stepBreakdown();
              return;
            }

            // Reach later station (diagram-aligned for prep 50 & 100, computed fallback for 80)
            kmDone = 480;
            battery = 80;

            if (prep === "50"){
              if (driving === "BAL") timeMin = 330; // 05:30
              if (driving === "ECO") timeMin = 350; // 05:50
            } else if (prep === "80"){
              // fallback: +45 min compared to prep 50 branch
              if (driving === "BAL") timeMin = 375; // 06:15
              if (driving === "ECO") timeMin = 395; // 06:35
            } else if (prep === "100"){
              if (driving === "SPT") timeMin = 390; // 06:30
              if (driving === "BAL") timeMin = 435; // 07:15
              if (driving === "ECO") timeMin = 515; // 08:35
            }

            stepDeadZonesSegment();
          }
        }
      ]);

      updateStats();
    }

    function stepBreakdown(){
      transitionTo(`
        <h2>Breakdown</h2>
        <p>Sport driving pushed you too far‚Ä¶ you broke down before reaching the charging station.</p>
        <p class="meta">Roadside Assistance is required to continue.</p>
      `);

      setChoices([
        {
          label: "Call Roadside Assistance",
          subtext: "Continue with a heavy time penalty.",
          action: () => {
            // Diagram node: 03:45 | 0% | 450/1000 (prep 50 path)
            if (prep === "50"){ timeMin = 225; battery = 0; kmDone = 450; }
            // Fallback for prep 80 sport breakdown
            if (prep === "80"){ timeMin = 270; battery = 0; kmDone = 450; }
            stepDeadZonesSegment(true);
          }
        }
      ]);

      updateStats();
    }

    function stepDeadZonesSegment(fromBreakdown=false){
      transitionTo(`
        <h2>Step 5 ‚Äì Dead zones & tunnels (segment)</h2>
        <p>You enter a new segment with many dead zones and tunnels.</p>
        <p class="meta">Copilot malus applies here (Google Maps +10%, e-Routes +5%, EV Routing 0%).</p>
      `);

      setChoices([
        {
          label: "Continue",
          subtext: "Complete the segment and reach the next strategic stop.",
          action: () => {
            // Move to 700 km as in diagram
            kmDone = 700;

            // Segment base durations (diagram: +3h35 / +3h / +4h25)
            let baseSeg = 0;
            let endBattery = 0;

            if (driving === "BAL"){ baseSeg = 215; endBattery = 30; } // 3h35
            if (driving === "SPT"){ baseSeg = 180; endBattery = 10; } // 3h00
            if (driving === "ECO"){ baseSeg = 265; endBattery = 55; } // 4h25

            if (fromBreakdown){ driving = "SPT"; baseSeg = 180; endBattery = 10; }

            timeMin += applyCopilotMalusOnSegment(baseSeg);
            battery = endBattery;

            stepLongBreakCharge();
          }
        }
      ]);

      updateStats();
    }

    function stepLongBreakCharge(){
      transitionTo(`
        <h2>Step 6 ‚Äì Long break & charging</h2>
        <p>Great job! You stop at a charging station for a long break: eat, rest, and recharge.</p>
        <p class="meta">Would you like to use your <b>my[Brand]</b> app during charging?</p>
      `);

      setChoices([
        {
          label: "Yes ‚Äì use my[Brand] during charging",
          subtext: "Optimized charging (no overcharge penalty).",
          action: () => {
            usedMyBrand = true;
            // Simplified but consistent with diagram logic
            timeMin += 65;  // charging + break
            battery = 80;
            stepFinalRunAndTires();
          }
        },
        {
          label: "No ‚Äì just plug in and charge",
          subtext: "Overcharge penalty (+30 min), ends higher but slower.",
          action: () => {
            usedMyBrand = false;
            timeMin += 95; // +30 min penalty
            battery = 85;
            stepFinalRunAndTires();
          }
        }
      ]);

      updateStats();
    }

    function stepFinalRunAndTires(){
      transitionTo(`
        <h2>Step 7 ‚Äì Final run & tire alert</h2>
        <p>Only <b>300 km</b> left to reach the Laboratory.</p>
        <p>At <b>60 km</b> from the finish line, you receive a critical alert: <b>Tire underinflation</b>.</p>
      `);

      setChoices([
        {
          label: "Use the SOS button to call the Call Center",
          subtext: "You lose time, but you save your tires.",
          action: () => {
            // Move to 940 km (diagram node shows 940/1000 at this step)
            kmDone = 940;
            timeMin += 110; // travel + handling delay (keeps multiple endings realistic)
            battery = 60;

            stepCallCenterOutcome();
          }
        },
        {
          label: "Keep driving (it‚Äôs almost finished)",
          subtext: "High risk: your tire may fully deflate.",
          action: () => {
            kmDone = 940;
            timeMin += 110;
            battery = 60;

            stepTireDeflated();
          }
        }
      ]);

      updateStats();
    }

    function stepCallCenterOutcome(){
      transitionTo(`
        <h2>Call Center guidance</h2>
        <p>Thanks to the Call Center, you locate the next station to reinflate.</p>
        <p class="meta">You lose time‚Ä¶ but you save your tires.</p>
      `);

      setChoices([
        {
          label: "Continue to the Laboratory",
          subtext: "Reach the finish and complete the final riddle.",
          action: () => {
            // Finish line reached (base completion)
            kmDone = 1000;
            timeMin += 30;  // reinflate + final approach
            battery = 50;

            stepFinalRiddle();
          }
        }
      ]);

      updateStats();
    }

    function stepTireDeflated(){
      transitionTo(`
        <h2>Tire fully deflated</h2>
        <p>Your tire is completely deflated. You cannot keep driving.</p>
        <p><b>Who do you call?</b></p>
      `);

      setChoices([
        {
          label: "Roadside Assistance",
          subtext: "Penalty: +1h30 + 0h40 (diagram).",
          action: () => {
            kmDone = 1000;
            timeMin += (90 + 40);
            battery = 55;
            stepFinalRiddle();
          }
        },
        {
          label: "Nearest dealership / point of sale",
          subtext: "Penalty: +24h (diagram).",
          action: () => {
            kmDone = 1000;
            timeMin += (24 * 60);
            battery = 35;
            stepFinalRiddle();
          }
        }
      ]);

      updateStats();
    }

    function stepFinalRiddle(){
      transitionTo(`
        <h2>Final riddle</h2>
        <p>You anticipate your arrival. You receive a mysterious call:</p>
        <p><b>"The room name is the physicist who 'invented' the electric light bulb!"</b></p>
        <p class="meta">What do you do?</p>
      `);

      setChoices([
        {
          label: "Ask ChatGPT",
          subtext: "You find the EDISON room immediately.",
          action: () => {
            // +0 min per diagram
            endMission(0);
          }
        },
        {
          label: "Use 'Alexa Vehicle to Home'",
          subtext: "You lose a bit of time in the corridors.",
          action: () => {
            // +5 min per diagram
            endMission(5);
          }
        },
        {
          label: "Ask a friend",
          subtext: "Wrong hint (EINSTEIN) ‚Äî you lose more time.",
          action: () => {
            // +15 min per diagram
            endMission(15);
          }
        }
      ]);

      updateStats();
    }

    function endMission(extraMin){
      timeMin += extraMin;

      transitionTo(`
        <h2>Mission completed!</h2>
        <p>You reached the Laboratory.</p>
        <p class="meta">Your score is based on your total time and remaining battery.</p>
      `);

      setChoices([]);
      showFinalScore();
      updateStats();
    }

    /* =========================
       SHAREPOINT IFRAME RESIZE
    ========================= */
    function sendHeight(){
      const height = document.documentElement.scrollHeight;
      parent.postMessage({ type: "resizePracticeSimV2", height }, "*");
    }
    function sendHeightDelayed(){ setTimeout(sendHeight, 250); }

    window.addEventListener("load", () => { sendHeight(); setInterval(sendHeight, 900); });
    window.addEventListener("resize", sendHeight);

    /* =========================
       START
    ========================= */
    startGame();
  </script>
</body>
</html>
