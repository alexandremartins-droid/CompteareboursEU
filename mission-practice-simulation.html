<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mission 2 ‚Äì The Practice (Interactive Simulation)</title>

  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;600;700;900&family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>
    html, body{
      margin:0;
      padding:40px 0 60px; /* ‚úÖ no left/right padding */
      background:transparent !important;
      font-family:'Inter', sans-serif;
      color:#d4e7ff;
      line-height:1.65;
    }

    /* Header */
    .header-badge{
      display:inline-block;
      padding:6px 14px;
      font-size:12px;
      border-radius:20px;
      border:1px solid #2aa8ff;
      color:#2aa8ff;
      margin:0 auto 12px;
      letter-spacing:1px;
      text-transform:uppercase;
      background: rgba(0,0,0,0.20);
      backdrop-filter: blur(10px);
    }
    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:0 20px; /* safe inner padding for small screens only */
    }

    h1{
      font-family:'Orbitron', sans-serif;
      font-size:40px;
      font-weight:800;
      letter-spacing:3px;
      color:#ffffff;
      margin:0 0 12px 0;
    }
    .subtitle{
      max-width:1100px;
      color:#b8dfff;
      margin:0 0 26px 0;
      font-size:15px;
    }

    /* Card */
    #game-container{
      max-width:1100px;
      background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.08);
      border-radius:18px;
      padding:28px 30px;
      backdrop-filter: blur(10px);
      box-shadow: 0 0 20px rgba(0,0,0,0.35);
    }

    /* Story panel (animated) */
    .panel{
      opacity:1;
      transform: translateY(0);
      transition: opacity 260ms ease, transform 260ms ease;
    }
    .panel.is-leaving{ opacity:0; transform: translateY(10px); }
    .panel.is-entering{ opacity:0; transform: translateY(-10px); }
    .panel.is-entered{ opacity:1; transform: translateY(0); }

    /* ‚úÖ Question more prominent */
    #story h2{
      font-family:'Orbitron', sans-serif;
      font-size:24px;          /* bigger */
      letter-spacing:2px;
      color:#3bc4ff;
      text-transform:uppercase;
      margin:0 0 12px 0;
      line-height:1.25;
    }
    #story p{
      margin:0;
      font-size:16px;
      color:#d4e7ff;
    }

    /* Choices */
    #choices{
      margin-top:18px;
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    @media (min-width: 860px){
      #choices{ grid-template-columns: 1fr 1fr; }
    }

    /* ‚úÖ Answers bigger + more readable */
    .choice-btn{
      width:100%;
      border:1px solid rgba(59,196,255,0.45);
      background: rgba(0,0,0,0.35);
      color:#ffffff;
      border-radius:16px;
      padding:18px 18px;
      cursor:pointer;
      font-size:17px;
      font-weight:800;
      letter-spacing:0.2px;
      text-align:left;
      transition: 0.22s ease;
      backdrop-filter: blur(10px);
      box-shadow: 0 0 0 rgba(0,0,0,0);
    }
    .choice-btn:hover{
      transform: translateY(-2px) scale(1.01);
      border-color: rgba(59,196,255,0.85);
      box-shadow: 0 0 18px rgba(59,196,255,0.18);
    }

    /* Stats */
    #stats{
      margin-top:22px;
      padding-top:14px;
      border-top:1px solid rgba(255,255,255,0.12);
      display:flex;
      flex-wrap:wrap;
      gap:10px 18px;
      justify-content:space-between;
    }
    .stat{
      background: rgba(0,0,0,0.28);
      border:1px solid rgba(255,255,255,0.08);
      border-radius:14px;
      padding:12px 14px;
      min-width: 230px;
      backdrop-filter: blur(10px);
      font-size:15px;
    }
    .stat b{ color:#3bc4ff; letter-spacing:0.2px; }

    /* Final score card */
    .score-card{
      margin-top:18px;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(59,196,255,0.35);
      border-radius: 16px;
      padding: 16px 18px;
      backdrop-filter: blur(12px);
      animation: fadeUp 420ms ease both;
    }

    .score-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
    }

    .score-value{
      font-family:'Orbitron', sans-serif;
      font-size:34px;
      font-weight:900;
      letter-spacing:3px;
      color:#19dfff;
      margin:0;
    }

    /* ‚úÖ Final CTA to the right */
    .final-cta{
      margin-left:auto;
      display:flex;
      justify-content:flex-end;
      align-items:flex-start;
    }

    /* ‚úÖ Hover matches DA */
    .btn-enter{
      display:inline-block;
      text-decoration:none;
      font-family:'Orbitron', sans-serif;
      font-size:16px;
      font-weight:900;
      letter-spacing:2px;
      text-transform:uppercase;
      padding:14px 22px;
      border-radius:16px;
      background:#19dfff;
      color:#062035;
      border:1px solid rgba(25,223,255,0.55);
      transition: 0.22s ease;
      white-space:nowrap;
    }
    .btn-enter:hover{
      background:#4be9ff;
      transform: translateY(-2px);
      box-shadow: 0 0 18px rgba(25,223,255,0.22);
    }

    /* Modal */
    .modal-overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 22px;
      z-index:9999;
    }
    .modal{
      width: min(720px, 100%);
      background: rgba(10,20,35,0.85);
      border:1px solid rgba(255,255,255,0.10);
      border-radius: 18px;
      padding: 18px 18px 14px 18px;
      backdrop-filter: blur(14px);
      box-shadow: 0 0 30px rgba(0,0,0,0.50);
      animation: fadeUp 220ms ease both;
    }
    .modal h3{
      margin:0 0 10px 0;
      font-family:'Orbitron', sans-serif;
      color:#ffffff;
      letter-spacing:2px;
      text-transform:uppercase;
      font-size:16px;
    }
    .modal p{
      margin:0 0 14px 0;
      color:#d4e7ff;
      font-size:14px;
      line-height:1.6;
    }
    .modal-actions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .modal-btn{
      border:1px solid rgba(255,255,255,0.12);
      border-radius: 14px;
      padding: 10px 14px;
      font-weight:900;
      cursor:pointer;
      transition: 0.2s ease;
      font-family:'Orbitron', sans-serif;
      letter-spacing:1px;
      text-transform:uppercase;
    }
    .modal-btn.primary{
      background:#19dfff;
      color:#062035;
      border-color: rgba(25,223,255,0.55);
    }
    .modal-btn.primary:hover{ transform: translateY(-1px); background:#4be9ff; }
    .modal-btn.secondary{
      background: rgba(0,0,0,0.25);
      color:#ffffff;
      border-color: rgba(59,196,255,0.35);
    }
    .modal-btn.secondary:hover{ transform: translateY(-1px); border-color: rgba(59,196,255,0.75); }

    @keyframes fadeUp{
      from{ opacity:0; transform: translateY(10px); }
      to{ opacity:1; transform: translateY(0); }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header-badge">Mission: Connected Heroes ¬∑ The Practice</div>
    <h1>Interactive Simulation</h1>
    <p class="subtitle">
      Make your choices step by step. Each decision impacts your <b>time</b>, your <b>battery</b>, and your <b>progress</b>.
    </p>

    <main id="game-container">
      <section id="story" class="panel" aria-live="polite"></section>
      <section id="choices"></section>

      <aside id="stats">
        <div class="stat">‚è± Time : <b><span id="time">00:00</span></b></div>
        <div class="stat">üîã Battery : <b><span id="battery">50</span></b>%</div>
        <div class="stat">üìç Progress : <b><span id="progress">0</span></b> / 1000 km</div>
      </aside>

      <div id="finalScore" style="display:none;"></div>
    </main>
  </div>

  <!-- Modal -->
  <div id="modalOverlay" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <h3 id="modalTitle">Decision</h3>
      <p id="modalText"></p>
      <div class="modal-actions">
        <button id="modalNo" class="modal-btn secondary" type="button">No</button>
        <button id="modalYes" class="modal-btn primary" type="button">Yes</button>
      </div>
    </div>
  </div>

  <script>
    /* =========================
       GAME STATE
    ========================= */
    let battery = 50;        // %
    let timeMin = 0;         // minutes (clamped, never negative)
    let kmDone = 0;          // progress in km

    let prep = "50";         // "50" | "80" | "100"
    let gps  = "EVR";        // "GM" | "ER" | "EVR"
    let driving = "BAL";     // "ECO" | "BAL" | "SPORT"

    const TOTAL_KM = 1000;

    /* =========================
       HELPERS
    ========================= */
    function clampState(){
      if (timeMin < 0) timeMin = 0;
      battery = Math.max(0, Math.min(100, Math.round(battery)));
      kmDone = Math.max(0, Math.min(TOTAL_KM, Math.round(kmDone)));
    }

    function minutesToHHMM(m){
      const mm = Math.max(0, Math.round(m));
      const h = Math.floor(mm / 60);
      const r = mm % 60;
      return `${String(h).padStart(2,"0")}:${String(r).padStart(2,"0")}`;
    }

    function updateStats(){
      clampState();
      document.getElementById("battery").textContent = battery;
      document.getElementById("time").textContent = minutesToHHMM(timeMin);
      document.getElementById("progress").textContent = kmDone;
      sendHeightDelayed();
    }

    function transitionTo(html){
      const story = document.getElementById("story");
      story.classList.add("is-leaving");
      setChoices([]);

      setTimeout(() => {
        story.classList.remove("is-leaving");
        story.classList.add("is-entering");
        story.innerHTML = html;

        requestAnimationFrame(() => {
          story.classList.add("is-entered");
          story.classList.remove("is-entering");
          setTimeout(() => story.classList.remove("is-entered"), 260);
        });

        sendHeightDelayed();
      }, 220);
    }

    function setStory(html){
      document.getElementById("story").innerHTML = html;
      sendHeightDelayed();
    }

    function setChoices(choices){
      const container = document.getElementById("choices");
      container.innerHTML = "";

      choices.forEach(choice => {
        const btn = document.createElement("button");
        btn.className = "choice-btn";
        btn.type = "button";
        btn.textContent = choice.label;
        btn.addEventListener("click", choice.action);
        container.appendChild(btn);
      });

      sendHeightDelayed();
    }

    /* =========================
       MODAL
    ========================= */
    function askModal({ title, text, yesLabel="Yes", noLabel="No" }){
      return new Promise(resolve => {
        const overlay = document.getElementById("modalOverlay");
        const t = document.getElementById("modalTitle");
        const p = document.getElementById("modalText");
        const yes = document.getElementById("modalYes");
        const no = document.getElementById("modalNo");

        t.textContent = title;
        p.textContent = text;
        yes.textContent = yesLabel;
        no.textContent = noLabel;

        overlay.style.display = "flex";
        overlay.setAttribute("aria-hidden", "false");

        const cleanup = () => {
          overlay.style.display = "none";
          overlay.setAttribute("aria-hidden", "true");
          yes.onclick = null;
          no.onclick = null;
        };

        yes.onclick = () => { cleanup(); resolve(true); };
        no.onclick  = () => { cleanup(); resolve(false); };

        sendHeightDelayed();
      });
    }

    /* =========================
       SCORE (simple + stable, never negative)
    ========================= */
    function computeScore(){
      // Fastest wins. Battery helps.
      // base 1200 - timeMin*1.2 + battery*2.0
      const base = 1200;
      const score = Math.max(0, Math.round(base - (timeMin * 1.2) + (battery * 2.0)));
      return score;
    }

    function showFinalScore(){
      const score = computeScore();
      const wrap = document.getElementById("finalScore");
      wrap.style.display = "block";
      wrap.innerHTML = `
        <div class="score-card">
          <div class="score-top">
            <p class="score-value">${score}</p>
            <div class="final-cta">
              <a class="btn-enter"
                 href="https://forms.cloud.microsoft/e/iHrWwNt9Bt"
                 target="_blank" rel="noopener">
                ENTER THE CODE
              </a>
            </div>
          </div>
        </div>
      `;
      sendHeightDelayed();
    }

    /* =========================
       GPS MALUS (diagram instruction)
       GM = +10% time, ER = +5%, EVR = +0%
    ========================= */
    function applyGpsMalus(minutes){
      const m = Math.max(0, minutes);
      if (gps === "GM")  return Math.round(m * 1.10);
      if (gps === "ER")  return Math.round(m * 1.05);
      return m; // EVR
    }

    /* =========================
       PATH IMPLEMENTATION (ALL BRANCHES)
    ========================= */
    function startGame(){
      battery = 50; timeMin = 0; kmDone = 0;
      prep = "50"; gps = "EVR"; driving = "BAL";
      document.getElementById("finalScore").style.display = "none";

      setStory(`
        <h2>Mission Briefing</h2>
        <p>Your goal: reach the Laboratory as fast as possible while optimizing your energy.</p>
      `);

      setChoices([{ label: "START THE SIMULATION", action: () => stepPrep() }]);
      updateStats();
    }

    function stepPrep(){
      transitionTo(`
        <h2>Step 1 ‚Äî Vehicle preparation</h2>
        <p>Before entering the mission, choose how you prepare your vehicle.</p>
      `);

      setChoices([
        { label: "Charge to 80% + preheat cabin & battery", action: () => { prep="80"; timeMin = 45; battery = 80; kmDone=0; stepGps(); } },
        { label: "Leave immediately (50%)", action: () => { prep="50"; timeMin = 0; battery = 50; kmDone=0; stepGps(); } },
        { label: "Charge to 100% + preheat cabin & battery", action: () => { prep="100"; timeMin = 135; battery = 100; kmDone=0; stepGps(); } }
      ]);

      updateStats();
    }

    function stepGps(){
      transitionTo(`
        <h2>Step 2 ‚Äî Choose your digital co-pilot</h2>
        <p>Select the app you will use to reach the Laboratory.</p>
      `);

      setChoices([
        { label: "Google Maps", action: () => { gps="GM"; stepDrive300(); } },
        { label: "e-Routes", action: () => { gps="ER"; stepDrive300(); } },
        { label: "eVrouting", action: () => { gps="EVR"; stepDrive300(); } }
      ]);

      updateStats();
    }

    function stepDrive300(){
      transitionTo(`
        <h2>Step 3 ‚Äî Driving style (300 km)</h2>
        <p>You enter a long 300 km expressway section. Choose your driving style.</p>
      `);

      setChoices([
        { label: "ECO driving", action: () => setAfter300("ECO") },
        { label: "BALANCED driving", action: () => setAfter300("BAL") },
        { label: "SPORT driving", action: () => setAfter300("SPORT") }
      ]);

      updateStats();
    }

    function setAfter300(style){
      driving = style;

      // Baseline values from the diagram for the 50% start:
      // ECO: 03:20 | 65% | 300
      // BAL: 02:45 | 45% | 300
      // SPORT: 02:15 | 20% | 300
      // For 80% start, diagram shows (incl +00:45):
      // ECO: 04:05 | 65% | 300
      // BAL: 03:30 | 45% | 300
      // SPORT: 02:45 | 20% | 300
      // For 100% start: we keep the same driving outcomes + initial time already in timeMin.
      // (We therefore set ONLY the driving segment duration from 50% baseline: 200 / 165 / 135)
      const segmentMinByStyle = { ECO: 200, BAL: 165, SPORT: 135 };

      // Reset to prep time then add driving segment:
      timeMin = (prep === "80") ? 45 : (prep === "100") ? 135 : 0;
      timeMin += segmentMinByStyle[style];

      if (style === "ECO") battery = 65;
      if (style === "BAL") battery = 45;
      if (style === "SPORT") battery = 20;

      kmDone = 300;

      stepStations();
      updateStats();
    }

    function stepStations(){
      transitionTo(`
        <h2>Step 4 ‚Äî Charging stations ahead</h2>
        <p>You exit the expressway. Two stations are available: one in 20 km and another in 180 km.</p>
        <p>What do you do?</p>
      `);

      setChoices([
        { label: "Stop at the next station (20 km)", action: () => stopNextStation() },
        { label: "Keep going (aim for the station at 180 km)", action: () => pushTo180() }
      ]);

      updateStats();
    }

    function stopNextStation(){
      // Stop next station: +15 min stop +30 min charge, progress to 320 km, battery -> 80
      timeMin += 45;
      kmDone = 320;
      battery = 80;

      stepSegment400();
      updateStats();
    }

    function pushTo180(){
      // From diagram: if SPORT -> breakdown before reaching the station
      if (driving === "SPORT"){
        // Breakdown state from diagram: 03:45 | 0% | 450 (for 80% path shown)
        // We simulate reaching 450 km then battery 0%.
        kmDone = 450;
        battery = 0;

        // Add an approximate time to reflect the breakdown moment (+60 min from 300 state)
        // (The exact timeline varies in the diagram; we keep the next node logic intact.)
        timeMin += 60;

        stepBreakdown();
        updateStats();
        return;
      }

      // If ECO or BAL: you keep going, then you charge
      // Diagram for 50% start:
      // ECO: (2h15 + 0h45) -> 05:50 | 80% | 480
      // BAL: (1h30 + 1h15) -> 05:30 | 80% | 480
      // We apply the increments rather than forcing absolute time.
      if (driving === "ECO") timeMin += (135 + 45);
      if (driving === "BAL") timeMin += (90 + 75);

      kmDone = 480;
      battery = 80;

      stepSegment400();
      updateStats();
    }

    function stepBreakdown(){
      transitionTo(`
        <h2>Incident ‚Äî Breakdown</h2>
        <p>You broke down before reaching the charging station.</p>
        <p>You must request assistance to continue.</p>
      `);

      setChoices([
        { label: "CALL ROADSIDE ASSISTANCE", action: () => roadsideAssistAfterBreakdown() }
      ]);

      updateStats();
    }

    function roadsideAssistAfterBreakdown(){
      // Roadside Assistance gets you back on track. We continue with the main path.
      // Add penalty time (kept minimal and consistent with the scenario).
      timeMin += 60;
      battery = 20;
      stepSegment400();
      updateStats();
    }

    function stepSegment400(){
      transitionTo(`
        <h2>Step 5 ‚Äî 400 km segment</h2>
        <p>You enter a new 400 km segment with many dead zones and tunnels.</p>
      `);

      setChoices([{ label: "CONTINUE", action: () => finishSegment400() }]);
      updateStats();
    }

    function finishSegment400(){
      // Segment durations from diagram (added to current time, then GPS malus applied):
      // BAL: +3h35, SPORT: +3h, ECO: +4h25
      let seg = 0;
      if (driving === "BAL") seg = 215;
      if (driving === "SPORT") seg = 180;
      if (driving === "ECO") seg = 265;

      timeMin += applyGpsMalus(seg);
      kmDone = 700; // diagram uses 700/1000 as milestone after this segment

      // battery after segment (diagram):
      if (driving === "BAL") battery = 30;
      if (driving === "SPORT") battery = 10;
      if (driving === "ECO") battery = 55;

      stepLongBreakCharge();
      updateStats();
    }

    async function stepLongBreakCharge(){
      transitionTo(`
        <h2>Step 6 ‚Äî Long break & charging</h2>
        <p>You stop for a long break and charge your car.</p>
        <p>Do you use your eRemote Control app during charging?</p>
      `);

      setChoices([
        { label: "YES", action: async () => { await applyMyBrand(true); } },
        { label: "NO",  action: async () => { await applyMyBrand(false); } }
      ]);

      updateStats();
    }

    async function applyMyBrand(yes){
      // Diagram indicates:
      // YES -> charge to 80% with shorter times
      // NO  -> overcharge, longer time, ends at 100% (or higher)
      // We apply charging time increments based on driving style (diagram values).
      if (yes){
        if (driving === "BAL") timeMin += 60;
        if (driving === "SPORT") timeMin += 150;
        if (driving === "ECO") timeMin += 45;
        battery = 80;
      } else {
        if (driving === "BAL") timeMin += 120;
        if (driving === "SPORT") timeMin += 210;
        if (driving === "ECO") timeMin += 105;
        battery = 100;
      }

      stepTireAlert();
      updateStats();
    }

    function stepTireAlert(){
      transitionTo(`
        <h2>Step 7 ‚Äî Tire underinflation alert</h2>
        <p>You have 300 km left. At 60 km from the finish line, you receive a tire underinflation alert.</p>
        <p>What do you do?</p>
      `);

      setChoices([
        { label: "USE SOS TO CALL THE CALL CENTER", action: () => pathCallCenter() },
        { label: "KEEP DRIVING", action: () => pathKeepDriving() }
      ]);

      updateStats();
    }

    function pathCallCenter(){
      // Diagram shows reaching ~940 km with a time addition (1h50 or 2h25 depending on branch visuals).
      // We use a consistent +110 min (1h50) baseline and keep the rest of the branch identical.
      timeMin += 110;
      kmDone = 940;
      battery = Math.max(0, battery - 20);

      // Final arrival after call center: add small arrival handling time and set end state.
      // The diagram shows end states around 14:50 / 15:50 etc depending paths.
      // We don‚Äôt hard-force absolute HH:MM; we preserve relative performance.
      timeMin += 45;  // regonflage + route to finish
      kmDone = 1000;

      stepRiddleAtArrival();
      updateStats();
    }

    function pathKeepDriving(){
      // Continuing without acting can lead to complete deflation.
      transitionTo(`
        <h2>Critical situation</h2>
        <p>Your tire is now fully deflated. You cannot keep driving.</p>
        <p>Who do you call?</p>
      `);

      setChoices([
        { label: "ROADSIDE ASSISTANCE", action: () => endRoadsideAssistance() },
        { label: "NEARBY DEALERSHIP (24H DELAY)", action: () => endPlus24h() }
      ]);

      updateStats();
    }

    function endRoadsideAssistance(){
      // Diagram: Roadside Assistance adds big penalty (1h30 + 0h40).
      timeMin += (90 + 40);
      kmDone = 1000;
      battery = Math.max(0, battery - 10);

      stepRiddleAtArrival();
      updateStats();
    }

    function endPlus24h(){
      // Diagram: +24h delay
      timeMin += (24 * 60);
      kmDone = 1000;
      battery = Math.max(0, battery - 15);

      stepRiddleAtArrival();
      updateStats();
    }

    function stepRiddleAtArrival(){
      transitionTo(`
        <h2>Final step ‚Äî The riddle</h2>
        <p>You anticipate your arrival. You receive a cryptic call:</p>
        <p><b>"The room name is the physicist who ‚Äòinvented‚Äô the electric light bulb."</b></p>
        <p>You‚Äôre not sure. What do you do?</p>
      `);

      setChoices([
        { label: "ASK CHATGPT", action: () => endChatGPT() },
        { label: "USE ALEXA (Vehicle to Home)", action: () => endAlexa() },
        { label: "CALL A FRIEND", action: () => endFriendWrong() }
      ]);

      updateStats();
    }

    function endChatGPT(){
      // Diagram: +0 min
      endSuccess(0);
    }

    function endAlexa(){
      // Diagram: +5 min
      endSuccess(5);
    }

    function endFriendWrong(){
      // Diagram: +15 min (wrong room: EINSTEIN)
      endSuccess(15);
    }

    function endSuccess(extraMin){
      timeMin += extraMin;

      transitionTo(`
        <h2>Mission completed!</h2>
        <p>You have finally reached the Laboratory.</p>
      `);

      setChoices([]);                 // ‚úÖ only final CTA remains
      showFinalScore();
      updateStats();
    }

    /* =========================
       SHAREPOINT IFRAME RESIZE
    ========================= */
    function sendHeight(){
      const height = document.documentElement.scrollHeight;
      parent.postMessage({ type: "resizePracticeSim", height }, "*");
    }
    function sendHeightDelayed(){ setTimeout(sendHeight, 250); }

    window.addEventListener("load", () => { sendHeight(); setInterval(sendHeight, 900); });
    window.addEventListener("resize", sendHeight);

    /* START */
    startGame();
  </script>
</body>
</html>
