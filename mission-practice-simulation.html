<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mission 2 ‚Äì The Practice (Simulation)</title>

  <!-- Orbitron + Inter (DA globale) -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;600;700;900&family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>
    html, body{
      margin:0;
      padding:40px;
      background:transparent !important;
      font-family:'Inter', sans-serif;
      color:#d4e7ff;
      line-height:1.65;
    }

    /* Header */
    .header-badge{
      display:inline-block;
      padding:6px 14px;
      font-size:12px;
      border-radius:20px;
      border:1px solid #2aa8ff;
      color:#2aa8ff;
      margin-bottom:12px;
      letter-spacing:1px;
      text-transform:uppercase;
      background: rgba(0,0,0,0.20);
      backdrop-filter: blur(10px);
    }
    h1{
      font-family:'Orbitron', sans-serif;
      font-size:40px;
      font-weight:800;
      letter-spacing:3px;
      color:#ffffff;
      margin:0 0 18px 0;
    }
    .subtitle{
      max-width:1100px;
      color:#b8dfff;
      margin:0 0 26px 0;
    }

    /* Card */
    #game-container{
      max-width:1100px;
      background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.08);
      border-radius:18px;
      padding:28px 30px;
      backdrop-filter: blur(10px);
      box-shadow: 0 0 20px rgba(0,0,0,0.35);
    }

    /* Story panel (animated) */
    .panel{
      opacity:1;
      transform: translateY(0);
      transition: opacity 260ms ease, transform 260ms ease;
    }
    .panel.is-leaving{
      opacity:0;
      transform: translateY(10px);
    }
    .panel.is-entering{
      opacity:0;
      transform: translateY(-10px);
    }
    .panel.is-entered{
      opacity:1;
      transform: translateY(0);
    }

    #story h2{
      font-family:'Orbitron', sans-serif;
      font-size:18px;
      letter-spacing:2px;
      color:#3bc4ff;
      text-transform:uppercase;
      margin:0 0 10px 0;
    }
    #story p{
      margin:0;
      font-size:15px;
      color:#d4e7ff;
    }
    .hint{
      margin-top:10px;
      font-size:13px;
      color:#9ed8ff;
      opacity:0.95;
    }

    /* Choices */
    #choices{
      margin-top:18px;
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 860px){
      #choices{
        grid-template-columns: 1fr 1fr;
      }
    }

    .choice-btn{
      width:100%;
      border:1px solid rgba(59,196,255,0.45);
      background: rgba(0,0,0,0.35);
      color:#ffffff;
      border-radius:14px;
      padding:14px 16px;
      cursor:pointer;
      font-size:15px;
      font-weight:700;
      letter-spacing:0.2px;
      text-align:left;
      transition: 0.22s ease;
      backdrop-filter: blur(10px);
    }
    .choice-btn:hover{
      transform: translateY(-2px);
      border-color: rgba(59,196,255,0.8);
      box-shadow: 0 0 18px rgba(59,196,255,0.18);
    }
    .choice-sub{
      margin-top:6px;
      font-size:13px;
      font-weight:500;
      color:#b8dfff;
      opacity:0.95;
    }

    /* Stats */
    #stats{
      margin-top:22px;
      padding-top:14px;
      border-top:1px solid rgba(255,255,255,0.12);
      display:flex;
      flex-wrap:wrap;
      gap:10px 18px;
      justify-content:space-between;
    }
    .stat{
      background: rgba(0,0,0,0.28);
      border:1px solid rgba(255,255,255,0.08);
      border-radius:14px;
      padding:10px 12px;
      min-width: 200px;
      backdrop-filter: blur(10px);
    }
    .stat b{
      color:#3bc4ff;
      letter-spacing:0.2px;
    }

    /* Final score card */
    .score-card{
      margin-top:18px;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(59,196,255,0.35);
      border-radius: 16px;
      padding: 16px 18px;
      backdrop-filter: blur(12px);
    }
    .score-title{
      font-family:'Orbitron', sans-serif;
      color:#ffffff;
      letter-spacing:2px;
      text-transform:uppercase;
      margin:0 0 8px 0;
      font-size:16px;
    }
    .score-value{
      font-family:'Orbitron', sans-serif;
      font-size:34px;
      font-weight:900;
      letter-spacing:3px;
      color:#19dfff;
      margin:0 0 8px 0;
    }
    .score-breakdown{
      margin:0;
      color:#b8dfff;
      font-size:14px;
      line-height:1.6;
    }

    /* Modal (replaces confirm) */
    .modal-overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 22px;
      z-index:9999;
    }
    .modal{
      width: min(720px, 100%);
      background: rgba(10,20,35,0.85);
      border:1px solid rgba(255,255,255,0.10);
      border-radius: 18px;
      padding: 18px 18px 14px 18px;
      backdrop-filter: blur(14px);
      box-shadow: 0 0 30px rgba(0,0,0,0.50);
    }
    .modal h3{
      margin:0 0 10px 0;
      font-family:'Orbitron', sans-serif;
      color:#ffffff;
      letter-spacing:2px;
      text-transform:uppercase;
      font-size:16px;
    }
    .modal p{
      margin:0 0 14px 0;
      color:#d4e7ff;
      font-size:14px;
      line-height:1.6;
    }
    .modal-actions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .modal-btn{
      border:1px solid rgba(255,255,255,0.12);
      border-radius: 14px;
      padding: 10px 14px;
      font-weight:800;
      cursor:pointer;
      transition: 0.2s ease;
      font-family:'Orbitron', sans-serif;
      letter-spacing:1px;
      text-transform:uppercase;
    }
    .modal-btn.primary{
      background:#19dfff;
      color:#062035;
      border-color: rgba(25,223,255,0.55);
    }
    .modal-btn.primary:hover{ transform: translateY(-1px); background:#4be9ff; }
    .modal-btn.secondary{
      background: rgba(0,0,0,0.25);
      color:#ffffff;
      border-color: rgba(59,196,255,0.35);
    }
    .modal-btn.secondary:hover{ transform: translateY(-1px); border-color: rgba(59,196,255,0.75); }

  </style>
</head>

<body>
  <div class="header-badge">Mission: Connected Heroes ¬∑ The Practice</div>
  <h1>Interactive Simulation</h1>
  <p class="subtitle">
    Faites vos choix et optimisez votre trajet. Chaque d√©cision impacte votre <b>temps</b>, votre <b>batterie</b> et votre <b>distance</b>.
  </p>

  <main id="game-container">
    <section id="story" class="panel" aria-live="polite"></section>
    <section id="choices"></section>

    <aside id="stats">
      <div class="stat">‚è± Temps : <b><span id="time">0</span></b> min</div>
      <div class="stat">üîã Batterie : <b><span id="battery">50</span></b>%</div>
      <div class="stat">üìç Distance : <b><span id="distance">1000</span></b> km</div>
      <div class="stat">‚ö° Bonus efficacit√© : <b><span id="bonus">0</span></b></div>
    </aside>

    <div id="finalScore" style="display:none;"></div>
  </main>

  <!-- Modal -->
  <div id="modalOverlay" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <h3 id="modalTitle">Choix</h3>
      <p id="modalText"></p>
      <div class="modal-actions">
        <button id="modalNo" class="modal-btn secondary" type="button">Non</button>
        <button id="modalYes" class="modal-btn primary" type="button">Oui</button>
      </div>
    </div>
  </div>

  <script>
    /* =========================
       VARIABLES DE JEU (logique conserv√©e)
    ========================= */
    let battery = 50;      // %
    let timeTotal = 0;     // minutes
    let distance = 1000;   // km restant
    let efficiencyBonus = 0;

    /* =========================
       OUTILS UI
    ========================= */
    function updateStats() {
      document.getElementById("battery").textContent = battery;
      document.getElementById("time").textContent = timeTotal;
      document.getElementById("distance").textContent = distance;
      document.getElementById("bonus").textContent = efficiencyBonus;
      sendHeightDelayed();
    }

    function transitionTo(html) {
      const story = document.getElementById("story");
      story.classList.add("is-leaving");
      setChoices([]); // on vide pendant la transition

      setTimeout(() => {
        story.classList.remove("is-leaving");
        story.classList.add("is-entering");
        story.innerHTML = html;

        requestAnimationFrame(() => {
          story.classList.add("is-entered");
          story.classList.remove("is-entering");
          setTimeout(() => story.classList.remove("is-entered"), 260);
        });

        sendHeightDelayed();
      }, 220);
    }

    function setStory(html) {
      // first render without animation glitch
      document.getElementById("story").innerHTML = html;
      sendHeightDelayed();
    }

    function setChoices(choices) {
      const container = document.getElementById("choices");
      container.innerHTML = "";

      choices.forEach(choice => {
        const btn = document.createElement("button");
        btn.className = "choice-btn";
        btn.type = "button";
        btn.textContent = choice.label;

        if (choice.subtext) {
          const sub = document.createElement("div");
          sub.className = "choice-sub";
          sub.textContent = choice.subtext;
          btn.appendChild(sub);
        }

        btn.addEventListener("click", choice.action);
        container.appendChild(btn);
      });

      sendHeightDelayed();
    }

    /* =========================
       MODALE (remplace confirm)
    ========================= */
    function askModal({ title, text, yesLabel="Oui", noLabel="Non" }) {
      return new Promise(resolve => {
        const overlay = document.getElementById("modalOverlay");
        const t = document.getElementById("modalTitle");
        const p = document.getElementById("modalText");
        const yes = document.getElementById("modalYes");
        const no = document.getElementById("modalNo");

        t.textContent = title;
        p.textContent = text;
        yes.textContent = yesLabel;
        no.textContent = noLabel;

        overlay.style.display = "flex";
        overlay.setAttribute("aria-hidden", "false");

        const cleanup = () => {
          overlay.style.display = "none";
          overlay.setAttribute("aria-hidden", "true");
          yes.onclick = null;
          no.onclick = null;
        };

        yes.onclick = () => { cleanup(); resolve(true); };
        no.onclick = () => { cleanup(); resolve(false); };

        sendHeightDelayed();
      });
    }

    /* =========================
       SCORE FINAL (ranking-ready)
       - Simple, lisible, extensible
    ========================= */
    function computeScore() {
      // Base: 1000 points
      // Malus temps: 2 pts / minute
      // Bonus efficacit√©: +50 par bonus
      // Batterie finale: +1 pt / %
      const base = 1000;
      const timePenalty = timeTotal * 2;
      const bonus = efficiencyBonus * 50;
      const batteryBonus = battery;

      const score = Math.max(0, Math.round(base - timePenalty + bonus + batteryBonus));
      return { score, base, timePenalty, bonus, batteryBonus };
    }

    function showFinalScore() {
      const { score, base, timePenalty, bonus, batteryBonus } = computeScore();
      const wrap = document.getElementById("finalScore");
      wrap.style.display = "block";
      wrap.innerHTML = `
        <div class="score-card">
          <p class="score-title">Final Score</p>
          <p class="score-value">${score}</p>
          <p class="score-breakdown">
            Base: <b>${base}</b><br>
            Time penalty: <b>-${timePenalty}</b><br>
            Efficiency bonus: <b>+${bonus}</b><br>
            Battery bonus: <b>+${batteryBonus}</b>
          </p>
        </div>
      `;
      sendHeightDelayed();
    }

    /* =========================
       BATTERIE / RECHARGE (logique conserv√©e + modale)
    ========================= */
    async function recharge({ forced=false } = {}) {
      const baseTime = forced ? 45 : 30;

      const useMarksAgentis = await askModal({
        title: "Recharge",
        text: "Utiliser l'app Marks Agentis ?",
        yesLabel: "Oui",
        noLabel: "Non"
      });

      const penalty = useMarksAgentis ? 0 : 15;

      timeTotal += (baseTime + penalty);
      battery = 80;

      if (!forced && useMarksAgentis) {
        efficiencyBonus = Math.max(efficiencyBonus, 3);
      }

      updateStats();
    }

    async function checkBattery() {
      if (battery < 20) {
        await recharge({ forced:true });
      }
    }

    /* =========================
       SC√âNARIO (√©tapes issues du diagramme)
       NB: textes sous boutons = explication du choix
    ========================= */

    function startGame() {
      setStory(`
        <h2>Briefing</h2>
        <p>Avant d‚Äôentrer en mission, tu dois pr√©parer le d√©part de ton trajet de <b>1 000 km</b>.</p>
        <p class="hint">Objectif : optimiser ton temps tout en gardant une batterie suffisante pour √©viter les p√©nalit√©s.</p>
      `);

      setChoices([
        { label: "Commencer la mission", subtext: "Lancer la simulation et effectuer tes premiers choix.", action: () => step1() }
      ]);

      updateStats();
    }

    function step1() {
      transitionTo(`
        <h2>√âtape 1 ‚Äì Pr√©paration du d√©part</h2>
        <p>Tu constates que ton v√©hicule n‚Äôa que <b>50%</b> de batterie au moment du d√©part.</p>
      `);

      setChoices([
        { label: "80% + pr√©chauffage", subtext: "Plus confortable, mais plus long au d√©part.", action: () => { battery = 80; timeTotal += 45; step2(); } },
        { label: "80% sans pr√©chauffage", subtext: "Bon compromis si tu veux limiter le temps.", action: () => { battery = 80; timeTotal += 45; step2(); } },
        { label: "D√©part imm√©diat (50%)", subtext: "Rapide‚Ä¶ mais attention au risque de recharge forc√©e.", action: () => { battery = 50; step2(); } },
        { label: "100% + pr√©chauffage", subtext: "Le plus s√ªr pour l‚Äôautonomie, mais tr√®s co√ªteux en temps.", action: () => { battery = 100; timeTotal += 135; step2(); } },
        { label: "100% sans pr√©chauffage", subtext: "Autonomie max au prix d‚Äôun gros temps de d√©part.", action: () => { battery = 100; timeTotal += 135; step2(); } },
      ]);

      updateStats();
    }

    function step2() {
      transitionTo(`
        <h2>√âtape 2 ‚Äì Choix du GPS</h2>
        <p>F√©licitations H√©ros ! Tu as pris ta premi√®re d√©cision. Avant d‚Äôaller plus loin, tu dois choisir ton copilote digital pour rejoindre le Laboratoire :</p>
      `);

      setChoices([
        { label: "Google Maps", subtext: "Solution classique, mais moins optimis√©e pour l‚Äô√©nergie.", action: async () => { timeTotal += 20; battery -= 5; await step3(); } },
        { label: "eRoute", subtext: "Optimisation plus efficace, meilleur compromis.", action: async () => { timeTotal += 10; battery -= 2; await step3(); } },
        { label: "eVrouting", subtext: "Approche d√©di√©e, focus sur l‚Äôitin√©raire √©lectrique.", action: async () => { await step3(); } },
      ]);

      updateStats();
    }

    async function step3() {
      updateStats();
      await checkBattery();

      transitionTo(`
        <h2>√âtape 3 ‚Äì Style de conduite (320 km)</h2>
        <p>Tu dois rouler sur une portion de <b>320 km</b>. Quel style de conduite adoptes-tu ?</p>
      `);

      setChoices([
        { label: "Conduite √©co", subtext: "Tu prot√®ges ta batterie, mais tu perds un peu de temps.", action: async () => { timeTotal += 15; battery -= 10; distance -= 320; await step4(); } },
        { label: "Conduite √©quilibr√©e", subtext: "Stable et efficace : bon √©quilibre global.", action: async () => { battery -= 20; distance -= 320; await step4(); } },
        { label: "Conduite sportive", subtext: "Plus rapide‚Ä¶ mais tr√®s co√ªteux en batterie.", action: async () => { timeTotal -= 10; battery -= 45; distance -= 320; await step4(); } },
      ]);

      updateStats();
    }

    async function step4() {
      updateStats();
      await checkBattery();

      transitionTo(`
        <h2>√âtape 4 ‚Äì Choix de la recharge</h2>
        <p>Apr√®s cette portion, tu dois encore parcourir <b>480 km</b> avant le prochain point strat√©gique. Souhaites-tu t‚Äôarr√™ter √† une station de recharge ?</p>
        <p class="hint">Attention : si la batterie passe trop bas, une recharge forc√©e peut ajouter du temps.</p>
      `);

      setChoices([
        { label: "S‚Äôarr√™ter √† la prochaine station", subtext: "Tu s√©curises la mission (et peux optimiser avec Marks Agentis).", action: async () => { await recharge({ forced:false }); distance -= 480; await step5(); } },
        { label: "Ne pas s‚Äôarr√™ter", subtext: "Gain de temps imm√©diat, mais risque √©lev√© de recharge forc√©e.", action: async () => {
            // On simule la consommation sur 480 km (simple) :
            distance -= 480;
            battery -= 35;
            await checkBattery();
            await step5();
          }
        },
      ]);

      updateStats();
    }

    async function step5() {
      updateStats();
      await checkBattery();

      transitionTo(`
        <h2>√âtape 5 ‚Äì Gestion des pneus</h2>
        <p>Sur ton trajet, tu re√ßois une notification concernant la pression des pneus. Quelle d√©cision prends-tu ?</p>
      `);

      setChoices([
        { label: "S‚Äôarr√™ter √† une station-service", subtext: "R√©action rapide et efficace pour s√©curiser le trajet.", action: () => { timeTotal += 10; endGame(); } },
        { label: "S‚Äôarr√™ter √† une aire de repos", subtext: "Possible, mais moins adapt√© √† une intervention technique rapide.", action: () => { timeTotal += 20; endGame(); } },
      ]);

      updateStats();
    }

    function endGame() {
      updateStats();

      transitionTo(`
        <h2>Mission termin√©e !</h2>
        <p>Bravo H√©ros. Ta simulation est termin√©e. Ton score a √©t√© calcul√© sur le temps total, la batterie finale et ton bonus d‚Äôefficacit√©.</p>
      `);

      setChoices([]);
      showFinalScore();
    }

    /* =========================
       SHAREPOINT IFRAME RESIZE
    ========================= */
    function sendHeight() {
      const height = document.documentElement.scrollHeight;
      parent.postMessage({ type: "resizePracticeSim", height }, "*");
    }
    function sendHeightDelayed() { setTimeout(sendHeight, 250); }

    window.addEventListener("load", () => { sendHeight(); setInterval(sendHeight, 900); });
    window.addEventListener("resize", sendHeight);

    /* =========================
       START
    ========================= */
    startGame();
  </script>
</body>
</html>
