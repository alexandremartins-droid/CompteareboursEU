<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mission 2 ‚Äì The Practice (Simulation)</title>

  <!-- Orbitron + Inter (DA globale) -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;600;700;900&family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>
    html, body{
      margin:0;
      padding:40px;
      background:transparent !important;
      font-family:'Inter', sans-serif;
      color:#d4e7ff;
      line-height:1.65;
    }

    /* Header */
    .header-badge{
      display:inline-block;
      padding:6px 14px;
      font-size:12px;
      border-radius:20px;
      border:1px solid #2aa8ff;
      color:#2aa8ff;
      margin-bottom:12px;
      letter-spacing:1px;
      text-transform:uppercase;
      background: rgba(0,0,0,0.20);
      backdrop-filter: blur(10px);
    }
    h1{
      font-family:'Orbitron', sans-serif;
      font-size:40px;
      font-weight:800;
      letter-spacing:3px;
      color:#ffffff;
      margin:0 0 18px 0;
    }
    .subtitle{
      max-width:1100px;
      color:#b8dfff;
      margin:0 0 26px 0;
    }

    /* Card */
    #game-container{
      max-width:1100px;
      background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.08);
      border-radius:18px;
      padding:28px 30px;
      backdrop-filter: blur(10px);
      box-shadow: 0 0 20px rgba(0,0,0,0.35);
    }

    /* Story panel (animated) */
    .panel{
      opacity:1;
      transform: translateY(0);
      transition: opacity 260ms ease, transform 260ms ease;
    }
    .panel.is-leaving{ opacity:0; transform: translateY(10px); }
    .panel.is-entering{ opacity:0; transform: translateY(-10px); }
    .panel.is-entered{ opacity:1; transform: translateY(0); }

    #story h2{
      font-family:'Orbitron', sans-serif;
      font-size:18px;
      letter-spacing:2px;
      color:#3bc4ff;
      text-transform:uppercase;
      margin:0 0 10px 0;
    }
    #story p{
      margin:0;
      font-size:15px;
      color:#d4e7ff;
    }
    .hint{
      margin-top:10px;
      font-size:13px;
      color:#9ed8ff;
      opacity:0.95;
    }

    /* Choices */
    #choices{
      margin-top:18px;
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 860px){
      #choices{ grid-template-columns: 1fr 1fr; }
    }

    .choice-btn{
      width:100%;
      border:1px solid rgba(59,196,255,0.45);
      background: rgba(0,0,0,0.35);
      color:#ffffff;
      border-radius:14px;
      padding:14px 16px;
      cursor:pointer;
      font-size:15px;
      font-weight:700;
      letter-spacing:0.2px;
      text-align:left;
      transition: 0.22s ease;
      backdrop-filter: blur(10px);
    }
    .choice-btn:hover{
      transform: translateY(-2px);
      border-color: rgba(59,196,255,0.8);
      box-shadow: 0 0 18px rgba(59,196,255,0.18);
    }
    .choice-sub{
      margin-top:6px;
      font-size:13px;
      font-weight:500;
      color:#b8dfff;
      opacity:0.95;
    }

    /* Stats */
    #stats{
      margin-top:22px;
      padding-top:14px;
      border-top:1px solid rgba(255,255,255,0.12);
      display:flex;
      flex-wrap:wrap;
      gap:10px 18px;
      justify-content:space-between;
    }
    .stat{
      background: rgba(0,0,0,0.28);
      border:1px solid rgba(255,255,255,0.08);
      border-radius:14px;
      padding:10px 12px;
      min-width: 220px;
      backdrop-filter: blur(10px);
    }
    .stat b{ color:#3bc4ff; letter-spacing:0.2px; }

    /* Final score card */
    .score-card{
      margin-top:18px;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(59,196,255,0.35);
      border-radius: 16px;
      padding: 16px 18px;
      backdrop-filter: blur(12px);
    }
    .score-title{
      font-family:'Orbitron', sans-serif;
      color:#ffffff;
      letter-spacing:2px;
      text-transform:uppercase;
      margin:0 0 8px 0;
      font-size:16px;
    }
    .score-value{
      font-family:'Orbitron', sans-serif;
      font-size:34px;
      font-weight:900;
      letter-spacing:3px;
      color:#19dfff;
      margin:0 0 8px 0;
    }
    .score-breakdown{
      margin:0;
      color:#b8dfff;
      font-size:14px;
      line-height:1.6;
    }

    /* Register-like button (end) */
    .btn-wrapper{
      margin-top:18px;
      display:flex;
      justify-content:center;
    }
    .btn{
      display:inline-block;
      text-decoration:none;
      font-family:'Orbitron', sans-serif;
      font-size:18px;
      font-weight:800;
      padding:16px 34px;
      border-radius:18px;
      color:#fff;
      transition:0.25s ease;
      letter-spacing:1px;
      text-transform:uppercase;
    }
    .btn-register{
      background:#ffb027;
      color:#0a1c2d;
    }
    .btn-register:hover{
      background:#ffc75a;
      transform: translateY(-2px);
    }

    /* Modal (replaces confirm) */
    .modal-overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 22px;
      z-index:9999;
    }
    .modal{
      width: min(720px, 100%);
      background: rgba(10,20,35,0.85);
      border:1px solid rgba(255,255,255,0.10);
      border-radius: 18px;
      padding: 18px 18px 14px 18px;
      backdrop-filter: blur(14px);
      box-shadow: 0 0 30px rgba(0,0,0,0.50);
    }
    .modal h3{
      margin:0 0 10px 0;
      font-family:'Orbitron', sans-serif;
      color:#ffffff;
      letter-spacing:2px;
      text-transform:uppercase;
      font-size:16px;
    }
    .modal p{
      margin:0 0 14px 0;
      color:#d4e7ff;
      font-size:14px;
      line-height:1.6;
    }
    .modal-actions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .modal-btn{
      border:1px solid rgba(255,255,255,0.12);
      border-radius: 14px;
      padding: 10px 14px;
      font-weight:800;
      cursor:pointer;
      transition: 0.2s ease;
      font-family:'Orbitron', sans-serif;
      letter-spacing:1px;
      text-transform:uppercase;
    }
    .modal-btn.primary{
      background:#19dfff;
      color:#062035;
      border-color: rgba(25,223,255,0.55);
    }
    .modal-btn.primary:hover{ transform: translateY(-1px); background:#4be9ff; }
    .modal-btn.secondary{
      background: rgba(0,0,0,0.25);
      color:#ffffff;
      border-color: rgba(59,196,255,0.35);
    }
    .modal-btn.secondary:hover{ transform: translateY(-1px); border-color: rgba(59,196,255,0.75); }

  </style>
</head>

<body>
  <div class="header-badge">Mission: Connected Heroes ¬∑ The Practice</div>
  <h1>Interactive Simulation</h1>
  <p class="subtitle">
    Fais tes choix et avance √©tape par √©tape. Chaque d√©cision impacte ton <b>temps</b>, ta <b>batterie</b> et ta <b>progression</b>.
  </p>

  <main id="game-container">
    <section id="story" class="panel" aria-live="polite"></section>
    <section id="choices"></section>

    <aside id="stats">
      <div class="stat">‚è± Temps : <b><span id="time">00:00</span></b></div>
      <div class="stat">üîã Batterie : <b><span id="battery">50</span></b>%</div>
      <div class="stat">üìç Progression : <b><span id="progress">0</span></b> / 1000 km</div>
    </aside>

    <div id="finalScore" style="display:none;"></div>
  </main>

  <!-- Modal -->
  <div id="modalOverlay" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <h3 id="modalTitle">Choix</h3>
      <p id="modalText"></p>
      <div class="modal-actions">
        <button id="modalNo" class="modal-btn secondary" type="button">Non</button>
        <button id="modalYes" class="modal-btn primary" type="button">Oui</button>
      </div>
    </div>
  </div>

  <script>
    /* =========================
       √âTAT (logique conserv√©e)
    ========================= */
    let battery = 50;          // %
    let minutesTotal = 0;      // minutes (00:00)
    let kmDone = 0;            // progression sur 1000
    let gpsChoice = null;      // "gm" | "eroute" | "evrouting"
    let driveStyle = null;     // "eco" | "balanced" | "sport"
    let stoppedAtStation = null; // true/false
    let usedMarksAgentis = null; // true/false
    let isLost = false;

    const TOTAL_KM = 1000;

    /* =========================
       HELPERS
    ========================= */
    function pad2(n){ return String(n).padStart(2,"0"); }
    function formatTime(min){
      const h = Math.floor(min/60);
      const m = min%60;
      return `${pad2(h)}:${pad2(m)}`;
    }
    function updateStats(){
      document.getElementById("battery").textContent = battery;
      document.getElementById("time").textContent = formatTime(minutesTotal);
      document.getElementById("progress").textContent = kmDone;
      sendHeightDelayed();
    }

    function transitionTo(html){
      const story = document.getElementById("story");
      story.classList.add("is-leaving");
      setChoices([]);

      setTimeout(() => {
        story.classList.remove("is-leaving");
        story.classList.add("is-entering");
        story.innerHTML = html;

        requestAnimationFrame(() => {
          story.classList.add("is-entered");
          story.classList.remove("is-entering");
          setTimeout(() => story.classList.remove("is-entered"), 260);
        });

        sendHeightDelayed();
      }, 220);
    }

    function setStory(html){
      document.getElementById("story").innerHTML = html;
      sendHeightDelayed();
    }

    function setChoices(choices){
      const container = document.getElementById("choices");
      container.innerHTML = "";

      choices.forEach(choice => {
        const btn = document.createElement("button");
        btn.className = "choice-btn";
        btn.type = "button";
        btn.textContent = choice.label;

        if(choice.subtext){
          const sub = document.createElement("div");
          sub.className = "choice-sub";
          sub.textContent = choice.subtext;
          btn.appendChild(sub);
        }

        btn.addEventListener("click", choice.action);
        container.appendChild(btn);
      });

      sendHeightDelayed();
    }

    /* =========================
       MODALE (remplace confirm)
    ========================= */
    function askModal({ title, text, yesLabel="Oui", noLabel="Non" }){
      return new Promise(resolve => {
        const overlay = document.getElementById("modalOverlay");
        const t = document.getElementById("modalTitle");
        const p = document.getElementById("modalText");
        const yes = document.getElementById("modalYes");
        const no = document.getElementById("modalNo");

        t.textContent = title;
        p.textContent = text;
        yes.textContent = yesLabel;
        no.textContent = noLabel;

        overlay.style.display = "flex";
        overlay.setAttribute("aria-hidden", "false");

        const cleanup = () => {
          overlay.style.display = "none";
          overlay.setAttribute("aria-hidden", "true");
          yes.onclick = null;
          no.onclick = null;
        };

        yes.onclick = () => { cleanup(); resolve(true); };
        no.onclick = () => { cleanup(); resolve(false); };

        sendHeightDelayed();
      });
    }

    /* =========================
       SCORE FINAL (SANS bonus efficacit√©)
    ========================= */
    function computeScore(){
      // Simple & ranking-ready:
      // Base 1000 - (temps * 2) + batterie
      const base = 1000;
      const timePenalty = minutesTotal * 2;
      const batteryBonus = battery;
      const score = Math.max(0, Math.round(base - timePenalty + batteryBonus));
      return { score, base, timePenalty, batteryBonus };
    }

    function showFinalScore(){
      const { score, base, timePenalty, batteryBonus } = computeScore();
      const wrap = document.getElementById("finalScore");
      wrap.style.display = "block";
      wrap.innerHTML = `
        <div class="score-card">
          <p class="score-title">Final Score</p>
          <p class="score-value">${score}</p>
          <p class="score-breakdown">
            Base: <b>${base}</b><br>
            Time penalty: <b>-${timePenalty}</b><br>
            Battery bonus: <b>+${batteryBonus}</b>
          </p>
          <div class="btn-wrapper">
            <a class="btn btn-register" href="https://forms.cloud.microsoft/e/iHrWwNt9Bt">
              ENTRE TON SCORE
            </a>
          </div>
        </div>
      `;
      sendHeightDelayed();
    }

    /* =========================
       PARCOURS (selon diagramme)
    ========================= */

    function startGame(){
      battery = 50; minutesTotal = 0; kmDone = 0;
      gpsChoice = null; driveStyle = null;
      stoppedAtStation = null; usedMarksAgentis = null;
      isLost = false;

      setStory(`
        <h2>Briefing</h2>
        <p>Tu d√©marres avec <b>50%</b> de batterie et un trajet total de <b>1 000 km</b>.</p>
        <p class="hint">Objectif : optimiser ton temps et √©viter les situations de panne.</p>
      `);

      setChoices([
        { label: "Commencer la mission", subtext: "Lancer la simulation et effectuer tes premiers choix.", action: step1 }
      ]);

      updateStats();
    }

    // √âtape 1 ‚Äì Pr√©paration du d√©part
    function step1(){
      transitionTo(`
        <h2>√âtape 1 ‚Äì Pr√©paration du d√©part</h2>
        <p>Tu constates que ton v√©hicule n‚Äôa que <b>50%</b> de batterie au moment du d√©part.</p>
      `);

      setChoices([
        { label:"80% + pr√©chauffage",
          subtext:"Pr√©-chauffage = confort / performance, mais temps de d√©part plus long.",
          action: () => { battery = 80; minutesTotal = 45; step2(); }
        },
        { label:"80% sans pr√©chauffage",
          subtext:"Bon compromis : tu s√©curises l‚Äôautonomie sans trop rallonger la pr√©paration.",
          action: () => { battery = 80; minutesTotal = 45; step2(); }
        },
        { label:"D√©part imm√©diat (50%)",
          subtext:"Tr√®s rapide‚Ä¶ mais tu prends un risque sur la suite du trajet.",
          action: () => { battery = 50; minutesTotal = 0; step2(); }
        },
        { label:"100% + pr√©chauffage",
          subtext:"Autonomie maximale, mais grosse perte de temps avant de partir.",
          action: () => { battery = 100; minutesTotal = 135; step2(); }
        },
        { label:"100% sans pr√©chauffage",
          subtext:"Autonomie max au prix d‚Äôun temps de charge important.",
          action: () => { battery = 100; minutesTotal = 135; step2(); }
        }
      ]);

      updateStats();
    }

    // √âtape 2 ‚Äì Choix GPS
    function step2(){
      transitionTo(`
        <h2>√âtape 2 ‚Äì Choix du GPS</h2>
        <p>Avant d‚Äôaller plus loin, tu dois choisir ton copilote digital.</p>
        <p class="hint">Note : Google Maps entra√Æne un <b>malus de 10%</b> sur une s√©quence plus tard (zones blanches).</p>
      `);

      setChoices([
        { label:"Google Maps",
          subtext:"Solution classique, mais moins adapt√©e √† certains segments (malus 10%).",
          action: () => { gpsChoice = "gm"; step3(); }
        },
        { label:"eRoute",
          subtext:"Optimise mieux l‚Äô√©nergie et l‚Äôitin√©raire pour l‚Äô√©lectrique.",
          action: () => { gpsChoice = "eroute"; step3(); }
        },
        { label:"eVrouting",
          subtext:"Solution d√©di√©e √† la planification EV, plus robuste sur les segments difficiles.",
          action: () => { gpsChoice = "evrouting"; step3(); }
        }
      ]);

      updateStats();
    }

    // √âtape 3 ‚Äì Style de conduite (300 km)
    function step3(){
      transitionTo(`
        <h2>√âtape 3 ‚Äì Style de conduite (300 km)</h2>
        <p>Tu dois parcourir une premi√®re portion de <b>300 km</b>. Quel style de conduite adoptes-tu ?</p>
      `);

      setChoices([
        { label:"Conduite √©co",
          subtext:"Tu pr√©serves l‚Äôautonomie‚Ä¶ mais tu perds du temps.",
          action: () => {
            driveStyle = "eco";
            // diagram: 03:20 | 65% | 300/1000
            minutesTotal = 200; battery = 65; kmDone = 300;
            step4();
          }
        },
        { label:"Conduite √©quilibr√©e",
          subtext:"Bon compromis temps / consommation.",
          action: () => {
            driveStyle = "balanced";
            // diagram: 02:45 | 45% | 300/1000
            minutesTotal = 165; battery = 45; kmDone = 300;
            step4();
          }
        },
        { label:"Conduite sportive",
          subtext:"Rapide‚Ä¶ mais tr√®s √©nergivore : risque √©lev√© sur la suite.",
          action: () => {
            driveStyle = "sport";
            // diagram: 02:15 | 20% | 300/1000
            minutesTotal = 135; battery = 20; kmDone = 300;
            step4();
          }
        }
      ]);

      updateStats();
    }

    // √âtape 4 ‚Äì Station de recharge (passage √† 320 km)
    async function step4(){
      updateStats();

      transitionTo(`
        <h2>√âtape 4 ‚Äì Station de recharge</h2>
        <p>Tu approches des <b>320 km</b>. Souhaites-tu t‚Äôarr√™ter √† la prochaine station ?</p>
        <p class="hint">Dans le diagramme : arr√™t = recharge + temps. Sans arr√™t = risque de panne sur la route.</p>
      `);

      setChoices([
        { label:"S‚Äôarr√™ter √† la prochaine station",
          subtext:"Tu s√©curises ta mission : tu repars avec une batterie solide.",
          action: async () => {
            stoppedAtStation = true;
            // On applique les valeurs diagramme apr√®s arr√™t (15 min + charge)
            kmDone = 320;
            battery = 80;
            if(driveStyle === "balanced") minutesTotal = 210; // 03:30
            if(driveStyle === "sport")    minutesTotal = 210; // 03:30
            if(driveStyle === "eco")      minutesTotal = 230; // 03:50
            updateStats();
            step5();
          }
        },
        { label:"Ne pas s‚Äôarr√™ter",
          subtext:"Gain de temps imm√©diat, mais si ta batterie est trop faible tu risques la panne.",
          action: () => {
            stoppedAtStation = false;
            // Diagramme : sportive = panne avant d‚Äôarriver
            if(driveStyle === "sport"){
              loseGame(`
                <h2>Panne‚Ä¶</h2>
                <p>Tu es tomb√© en panne <b>avant</b> d‚Äôatteindre la station. Mission interrompue.</p>
              `);
              return;
            }
            // Eco & √©quilibr√©e : ils finissent par s‚Äôarr√™ter plus tard (recharge forc√©e)
            // On place directement l‚Äô√©tat diagramme "arriv√©e" au checkpoint 480 km
            kmDone = 480;
            battery = 80;
            if(driveStyle === "balanced") minutesTotal = 330; // 05:30
            if(driveStyle === "eco")      minutesTotal = 350; // 05:50
            updateStats();
            step6();
          }
        }
      ]);
    }

    // √âtape 5 ‚Äì Question Marks Agentis apr√®s arr√™t (si stop)
    async function step5(){
      if(!stoppedAtStation){
        step6();
        return;
      }

      const useApp = await askModal({
        title:"Recharge",
        text:"Utiliser l'app Marks Agentis ?",
        yesLabel:"Oui",
        noLabel:"Non"
      });
      usedMarksAgentis = useApp;

      // Diagramme : utilisation = p√©nalit√© d‚Äôovercharge (+30 min) et batterie 85
      if(usedMarksAgentis){
        battery = 85;
        minutesTotal += 30; // malus overcharge
      }else{
        battery = 80;
      }

      updateStats();
      step6();
    }

    // √âtape 6 ‚Äì Petite route / station (20 km vs 180 km)
    function step6(){
      transitionTo(`
        <h2>√âtape 5 ‚Äì Prochaine recharge sur une petite route</h2>
        <p>Une alerte indique une station dans <b>20 km</b> et une autre dans <b>180 km</b>. Que fais-tu ?</p>
      `);

      setChoices([
        { label:"S‚Äôarr√™ter dans 20 km",
          subtext:"Choix prudent : tu r√©duis le risque sur route isol√©e.",
          action: () => {
            // pas de chiffres explicites ici : on fait un l√©ger co√ªt temps
            minutesTotal += 10;
            kmDone += 20;
            updateStats();
            step7();
          }
        },
        { label:"Continuer jusqu‚Äô√† 180 km",
          subtext:"Tu gagnes du temps‚Ä¶ mais la route est plus risqu√©e (zones blanches).",
          action: () => {
            minutesTotal += 0;
            kmDone += 180;
            updateStats();
            step7();
          }
        }
      ]);
    }

    // √âtape 7 ‚Äì Segment 400 km (zones blanches / tunnels) + malus Google Maps
    function step7(){
      transitionTo(`
        <h2>√âtape 6 ‚Äì Segment ‚Äúzones blanches‚Äù (400 km)</h2>
        <p>Tu entres dans une zone avec tunnels et faible connectivit√©. Ton choix GPS peut impacter ton temps.</p>
      `);

      setChoices([
        { label:"Poursuivre la mission",
          subtext:"Le segment est calcul√© en tenant compte du GPS et de ton style de conduite.",
          action: () => {
            // Diagramme au checkpoint 720 km (malus GM 10% affich√©)
            kmDone = 720;

            const gmMalus = (gpsChoice === "gm");
            // √âtats diagramme "Google Maps Malus 10%" :
            if(driveStyle === "balanced"){
              minutesTotal = gmMalus ? 415 : 395; // 06:55 vs 06:35 (approx)
              battery = 30;
            }
            if(driveStyle === "sport"){
              minutesTotal = gmMalus ? 345 : 335; // 05:45 vs 05:35 (approx)
              battery = 10;
            }
            if(driveStyle === "eco"){
              minutesTotal = gmMalus ? 510 : 480; // 08:30 vs 08:00 (approx)
              battery = 55;
            }

            updateStats();
            step8();
          }
        }
      ]);
    }

    // √âtape 8 ‚Äì Long stop: eat + recharge to 80 / 85
    async function step8(){
      transitionTo(`
        <h2>√âtape 7 ‚Äì Pause & recharge</h2>
        <p>Tu arrives √† une station : tu recharges et tu prends une pause pour manger.</p>
        <p class="hint">Le diagramme distingue ‚Äúavec app‚Äù (overcharge malus) / ‚Äúsans app‚Äù.</p>
      `);

      const useApp = await askModal({
        title:"Recharge",
        text:"Utiliser l'app Marks Agentis ?",
        yesLabel:"Oui",
        noLabel:"Non"
      });
      usedMarksAgentis = useApp;

      // Diagramme states (approxim√©s en minutes, coh√©rents avec les timestamps fournis)
      if(usedMarksAgentis){
        battery = 85;
        if(driveStyle === "balanced") minutesTotal = 505; // 08:25
        if(driveStyle === "sport")    minutesTotal = 555; // 09:15
        if(driveStyle === "eco")      minutesTotal = 585; // 09:45
      } else {
        battery = 80;
        if(driveStyle === "balanced") minutesTotal = 475; // 07:55
        if(driveStyle === "sport")    minutesTotal = 495; // 08:15
        if(driveStyle === "eco")      minutesTotal = 555; // 09:15
      }

      updateStats();
      step9();
    }

    // √âtape 9 ‚Äì Final segment (arrive at 940 km, tire alert)
    function step9(){
      transitionTo(`
        <h2>√âtape 8 ‚Äì Alerte pression pneus</h2>
        <p>√Ä <b>60 km</b> de l‚Äôarriv√©e (progression <b>940 / 1000 km</b>), une alerte indique un sous-gonflage.</p>
        <p class="hint">Le diagramme montre qu‚Äôil faut agir tout de suite, sinon risque d‚Äô√©clatement.</p>
      `);

      // On positionne √† 940 km (diagramme)
      kmDone = 940;

      // On mappe les 3 √©tats du diagramme selon style (coh√©rent avec les trois lignes)
      if(driveStyle === "eco"){      minutesTotal = 735; battery = 60; } // 12:15 | 60%
      if(driveStyle === "balanced"){ minutesTotal = 660; battery = 30; } // 11:00 | 30%
      if(driveStyle === "sport"){    minutesTotal = 625; battery = 50; } // 10:25 | 50%

      updateStats();

      setChoices([
        { label:"Appeler le Call Center imm√©diatement",
          subtext:"Le bon r√©flexe : prise en charge et s√©curisation du trajet.",
          action: () => step10_callCenter()
        },
        { label:"Continuer sans s‚Äôarr√™ter",
          subtext:"Tr√®s risqu√© : le pneu peut √©clater et te faire perdre la mission.",
          action: () => step10_continue()
        }
      ]);
    }

    // Branche Call Center
    function step10_callCenter(){
      transitionTo(`
        <h2>Assistance ‚Äì Call Center</h2>
        <p>Le Call Center te guide et organise la suite. Quelle option choisis-tu ?</p>
      `);

      setChoices([
        { label:"Aller √† la station-service la plus proche",
          subtext:"Option rapide : tu limites le retard, mais tu consommes un peu.",
          action: () => {
            // √âtats diagramme (arriv√©e)
            if(driveStyle === "eco"){      minutesTotal = 805; battery = 50; } // 13:25 | 50%
            if(driveStyle === "balanced"){ minutesTotal = 685; battery = 25; } // 11:25 | ~25/35
            if(driveStyle === "sport"){    minutesTotal = 710; battery = 35; } // 11:50 | 35% (approx)
            kmDone = 1000;
            updateStats();
            endGame(true);
          }
        },
        { label:"Roadside assistance (d√©pannage)",
          subtext:"Plus long, mais solution compl√®te et s√©curis√©e.",
          action: () => {
            if(driveStyle === "eco"){      minutesTotal = 865; battery = 55; } // 14:25 | 55%
            if(driveStyle === "balanced"){ minutesTotal = 745; battery = 55; } // 12:25 | 55%
            if(driveStyle === "sport"){    minutesTotal = 740; battery = 20; } // 12:20 | 20% (approx)
            kmDone = 1000;
            updateStats();
            endGame(true);
          }
        }
      ]);
    }

    // Branche continuer -> √©clatement
    function step10_continue(){
      transitionTo(`
        <h2>Incident</h2>
        <p>Le pneu √©clate. Tu dois choisir qui appeler.</p>
      `);

      setChoices([
        { label:"Appeler l‚Äôassurance",
          subtext:"Mauvais r√©flexe ici : tu perds trop de temps, mission √©chou√©e (diagramme).",
          action: () => {
            loseGame(`
              <h2>YOU LOSE</h2>
              <p>Tu as appel√© l‚Äôassurance : prise en charge trop lente. Mission √©chou√©e.</p>
            `);
          }
        },
        { label:"Appeler le Call Center",
          subtext:"Le Call Center est le point d‚Äôentr√©e le plus efficace dans ce contexte.",
          action: () => {
            // On revient sur une issue ‚Äúd√©pannage‚Äù mais avec p√©nalit√©
            minutesTotal += 90;
            battery = Math.max(5, battery - 10);
            kmDone = 1000;
            updateStats();
            endGame(false);
          }
        }
      ]);
    }

    function endGame(cleanFinish){
      transitionTo(`
        <h2>Mission termin√©e !</h2>
        <p>
          Bravo H√©ros. Tu as termin√© la simulation ${cleanFinish ? "avec une ex√©cution ma√Ætris√©e" : "malgr√© un incident"}.
          Ton score est bas√© sur ton <b>temps total</b> et ta <b>batterie finale</b>.
        </p>
      `);

      setChoices([]);
      showFinalScore();
    }

    function loseGame(html){
      isLost = true;
      transitionTo(html);
      setChoices([
        { label:"Rejouer la simulation",
          subtext:"Repars du d√©but pour optimiser tes d√©cisions.",
          action: startGame
        }
      ]);
      updateStats();
      document.getElementById("finalScore").style.display = "none";
      sendHeightDelayed();
    }

    /* =========================
       SHAREPOINT IFRAME RESIZE
    ========================= */
    function sendHeight(){
      const height = document.documentElement.scrollHeight;
      parent.postMessage({ type: "resizePracticeSim", height }, "*");
    }
    function sendHeightDelayed(){ setTimeout(sendHeight, 250); }

    window.addEventListener("load", () => { sendHeight(); setInterval(sendHeight, 900); });
    window.addEventListener("resize", sendHeight);

    /* =========================
       START
    ========================= */
    startGame();
  </script>
</body>
</html>
